<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frecuencia Vital - Plan de Estudio</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap');
        :root{--bg-color:#121212;--cell-bg:#1a1a1a;--main-border:#2c2c2c;--text-color:#e0e0e0;--text-secondary:#a0a0a0;--accent-color:#00FF7F;--meta-bg:#181c25;--meta-header-bg:#101217;--meta-border:#2c3240;--meta-text:#a9bce2;--plan-bg:#1e1e1e;--vfd-green:#50E050;--progress-score-bg:#4caf50;--progress-advance-bg:#ff9800;--text-completed:#777;--bullet-completed:#555;--tag-text-dark:#111;--error-color:#ff6b6b;--warning-color:#ff9800;--shadow-color:rgba(0,0,0,0.4);--step-1-color:#03dac6;--step-2-color:#ffb74d;--step-3-color:#4fc3f7;--step-4-color:#ce93d8;--step-5-color:#ef9a9a;--step-6-color:#a5d6a7;--color-todo:var(--text-secondary);--color-inprogress:var(--step-3-color);--color-done:var(--vfd-green);--rentable-color:#F472B6}
        *{box-sizing:border-box;margin:0;padding:0}
        body{font-family:'Source Sans Pro',sans-serif;background-color:var(--bg-color);color:var(--text-color);margin:0;overflow:hidden;height:100vh;display:flex;flex-direction:column}
        .app-banner{padding:20px 25px;background-color:var(--bg-color);border-bottom:1px solid var(--main-border);flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:20px}
        .banner-bottom-row{display:flex;width:100%;align-items:center;gap:20px}
        .global-progress-container{flex-grow:1;display:flex;flex-direction:column;gap:10px}
        .main-content-area{flex-grow:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--main-border) var(--bg-color)}
        .view-wrapper{padding:20px}
        .view-wrapper.hidden{display:none}
        .view-switcher{background-color:var(--accent-color);color:var(--bg-color);border:none;padding:10px 20px;border-radius:6px;font-family:'Orbitron',sans-serif;font-weight:700;cursor:pointer;transition:all .2s ease;flex-shrink:0}
        .view-switcher:hover{background-color:#39ff94;transform:translateY(-2px)}
        .motivational-quote{font-family:'Orbitron',sans-serif;color:var(--vfd-green);font-size:1.5em;text-transform:uppercase;letter-spacing:2px;text-shadow:0 0 4px rgba(80,224,80,.6),0 0 8px rgba(80,224,80,.4);min-height:1.2em}
        .countdown-container{position:relative;display:inline-block}
        .countdown-timer-container{display:flex;justify-content:center;align-items:center;gap:25px}
        .countdown-unit{text-align:center}
        .countdown-label{font-family:'Orbitron',sans-serif;font-size:.8em;color:var(--vfd-green);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;opacity:.8}
        .countdown-digits{font-family:'Orbitron',sans-serif;font-size:4em;color:var(--vfd-green);line-height:1;text-shadow:0 0 5px rgba(80,224,80,.7),0 0 10px rgba(80,224,80,.5),0 0 15px rgba(80,224,80,.3)}
        #edit-countdown-btn{position:absolute;top:-5px;right:-30px;background:none;border:none;color:var(--meta-text);font-size:1.2em;cursor:pointer;transition:color .2s}
        #edit-countdown-btn:hover{color:var(--accent-color)}
        #countdown-editor{display:none;margin-top:10px;align-items:center;justify-content:center;gap:10px}
        #countdown-date-picker{background-color:var(--cell-bg);border:1px solid var(--main-border);color:var(--text-color);padding:5px;border-radius:4px;font-family:'Source Sans Pro',sans-serif}
        #countdown-date-picker::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer}
        #save-countdown-btn{background-color:var(--accent-color);color:var(--bg-color);border:none;padding:6px 12px;border-radius:4px;font-weight:bold;cursor:pointer}
        .progress-bar-wrapper{display:flex;flex-direction:column;gap:4px}
        .progress-bar-wrapper label{font-size:.85em;color:var(--meta-text);font-weight:600;text-align:left}
        .progress-bar-background{width:100%;background-color:var(--main-border);border-radius:8px;height:22px;overflow:hidden}
        .progress-bar-fill{height:100%;width:0%;border-radius:8px;transition:width .5s ease-in-out;text-align:center;line-height:22px;color:var(--bg-color);font-weight:bold;font-size:.8em}
        #global-score-bar{background-color:var(--progress-score-bg)}
        #global-advance-bar{background-color:var(--progress-advance-bg)}
        .calendar-container{display:grid;grid-template-columns:40px 40px repeat(7,1fr);gap:2px;background-color:var(--main-border)}
        .header-cell,.day-header{text-align:center;padding:12px 5px;font-weight:600;font-family:'Orbitron',sans-serif;text-transform:uppercase;font-size:.9em}
        .meta-header{background-color:var(--meta-header-bg);color:var(--meta-text);border-bottom:2px solid var(--main-border)}
        .day-header{background-color:var(--cell-bg);color:var(--accent-color);border-bottom:2px solid var(--main-border)}
        .month-cell{grid-column:1;background-color:var(--meta-bg);color:var(--meta-text);font-family:'Orbitron',sans-serif;writing-mode:vertical-rl;text-transform:uppercase;letter-spacing:2px;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--meta-border)}
        .week-cell-container{grid-column:2;background-color:var(--meta-bg);position:relative;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--meta-border)}
        .week-number{font-family:'Orbitron',sans-serif;font-size:1.6em;color:var(--meta-text)}
        .day-cell{background-color:var(--cell-bg);min-height:160px;padding:8px 12px;position:relative;overflow-y:auto;cursor:pointer;transition:all .2s;border:2px solid transparent}
        .day-cell.empty{background-color:var(--bg-color);cursor:default}
        .day-cell.drag-over{background-color:var(--meta-bg);border-color:var(--accent-color)}
        .day-cell.target-date{border-color:var(--error-color);box-shadow:0 0 10px rgba(255,107,107,.4)}
        .day-cell.target-date .calendar-day-number{color:var(--error-color);font-weight:bold}
        .day-cell.day-before-target{border-color:var(--warning-color)}
        .day-cell.day-before-target .calendar-day-number{color:var(--warning-color)}
        .calendar-day-number{font-size:.9em;font-weight:600;color:#777;position:absolute;top:8px;right:12px;z-index:1;transition:color .2s}
        .day-content ul{list-style-type:none;padding-left:0;margin:25px 0 0}
        .day-content li{margin-bottom:4px;padding-left:14px;position:relative;font-size:.85em}
        .day-content .subject-title{color:var(--text-color);font-weight:700;display:block;margin-bottom:6px;text-transform:uppercase;font-size:1em;text-shadow:0 0 4px rgba(255,255,255,.15);padding-left:0;transition:color .4s ease}
        .day-content .subject-title.subject-completed{color:var(--text-completed);text-shadow:none;font-style:italic}
        .subject-title::before{content:none!important}
        .subject-score{color:var(--meta-text);font-size:.8em;font-weight:400;margin-left:8px}
        .topic-item{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;margin-left:-6px;border-radius:4px;transition:all .2s;border-top:2px solid transparent;border-bottom:2px solid transparent}
        .topic-item[draggable=true]{cursor:grab}
        .topic-item.dragging{opacity:.5}
        .topic-item:not(.topic-completed):not(.dragging):hover{background-color:var(--meta-bg);color:var(--accent-color)}
        .topic-item.drag-over-top{border-top-color:var(--accent-color)}
        .topic-item.drag-over-bottom{border-bottom-color:var(--accent-color)}
        .topic-item::before{content:'■';position:absolute;left:0;top:5px;color:var(--accent-color);font-size:.8em;line-height:1.5;transition:color .3s ease}
        .topic-score{font-size:.85em;font-weight:bold;margin-left:10px;flex-shrink:0}
        .topic-item.topic-completed{color:var(--text-completed)!important;font-style:italic!important}
        .topic-item.topic-completed:hover{color:var(--text-completed)!important;background-color:transparent}
        .topic-item.topic-completed::before{color:var(--bullet-completed)!important}
        .topic-item.topic-rentable>span{color:var(--rentable-color);font-weight:600}
        .topic-item.topic-rentable::before{color:var(--rentable-color)}
        .topic-item.topic-rentable:not(.topic-completed):not(.dragging):hover>span{color:#ff9ee2}
        .topic-item.topic-completed.topic-rentable>span{color:var(--text-completed)!important;font-weight:normal!important}
        .kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;height:100%}
        .kanban-column{background-color:var(--plan-bg);border-radius:12px;display:flex;flex-direction:column;max-height:100%}
        .kanban-column-header{padding:15px 20px;border-bottom:1px solid var(--main-border);display:flex;align-items:center;gap:10px;position:sticky;top:0;background-color:var(--plan-bg);z-index:10}
        .kanban-column-header h2{font-size:1.1rem;font-weight:600}
        #col-todo .kanban-column-header h2,#col-todo .kanban-column-header i{color:var(--color-todo)}
        #col-inprogress .kanban-column-header h2,#col-inprogress .kanban-column-header i{color:var(--color-inprogress)}
        #col-done .kanban-column-header h2,#col-done .kanban-column-header i{color:var(--color-done)}
        .cards-container{flex-grow:1;padding:10px 20px 20px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--main-border) var(--plan-bg)}
        .specialty-header{display:flex;flex-direction:column;gap:5px;margin:20px 0 10px;padding:10px;border-radius:6px;background-color:var(--meta-bg);border-left:4px solid}
        .specialty-header-main{display:flex;justify-content:space-between;align-items:center}
        .specialty-header-main h3{font-size:1.1rem;font-weight:700;margin:0}
        .specialty-progress-wrapper{display:flex;align-items:center;gap:8px}
        .specialty-progress-wrapper small{font-size:.7rem;color:var(--meta-text);width:40px;flex-shrink:0}
        .specialty-progress-container{flex-grow:1;height:8px;background-color:var(--main-border);border-radius:4px}
        .specialty-progress-bar{height:100%;width:0%;border-radius:4px;transition:all .3s ease;background-color:var(--progress-advance-bg)}
        .specialty-score-bar{height:100%;width:0%;border-radius:4px;transition:all .3s ease}
        .specialty-score-bar.low{background-color:var(--error-color)}
        .specialty-score-bar.medium{background-color:var(--warning-color)}
        .specialty-score-bar.high{background-color:var(--vfd-green)}
        .specialty-percentage-text{font-size:.8em;font-weight:600;color:var(--text-secondary);width:45px;text-align:right;flex-shrink:0}
        .kanban-card{background-color:var(--cell-bg);border-radius:8px;margin-bottom:10px;box-shadow:0 2px 8px var(--shadow-color);cursor:pointer;transition:border-left-color .3s}
        .kanban-card:hover{background-color:var(--meta-bg)}
        .card-summary{padding:12px 15px}
        .card-topic-name{font-weight:600}
        .kanban-card.topic-rentable .card-topic-name{color:var(--rentable-color)}
        #col-done .kanban-card .card-topic-name{color:var(--text-completed)!important;font-style:italic!important;font-weight:normal!important}
        .card-progress-display{display:flex;align-items:center;gap:15px;margin-top:10px}
        .card-progress-bar-container{flex-grow:1;height:6px;background-color:var(--main-border);border-radius:3px}
        .card-progress-bar{height:100%;width:0%;border-radius:3px;transition:width .3s ease}
        .card-progress-text,.card-score-text{font-size:.75rem;font-weight:600;color:var(--text-secondary)}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:998;display:none;opacity:0;transition:opacity .3s ease}
        .modal-overlay.visible{display:block;opacity:1}
        .modal-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:var(--cell-bg);border:1px solid var(--main-border);border-radius:12px;box-shadow:0 5px 25px rgba(0,0,0,.5);z-index:1000;width:90%;max-height:90vh;display:none;flex-direction:column;transition:transform .3s ease,opacity .3s ease}
        .modal-container.visible{display:flex}
        .modal-header{padding:15px 25px;border-bottom:1px solid var(--main-border);display:flex;justify-content:space-between;align-items:center}
        .modal-header h2{margin:0;font-family:'Orbitron',sans-serif;font-size:1.5em}
        .modal-close{font-size:2em;color:#888;cursor:pointer;line-height:1;transition:color .2s}
        .modal-close:hover{color:var(--text-color)}
        .modal-content{padding:25px;overflow-y:auto}
        #details-modal{max-width:650px;z-index:1000}
        #details-modal .modal-header h2{color:var(--accent-color)}
        #modal-notes{width:100%;box-sizing:border-box;min-height:120px;background-color:#2c2c2c;border:1px solid var(--main-border);color:var(--text-color);padding:10px;resize:vertical;border-radius:4px}
        #modal-save-btn{width:100%;padding:12px;margin-top:10px;background-color:var(--accent-color);color:var(--bg-color);border:none;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:1em;border-radius:4px;transition:background-color .2s,transform .1s}
        #modal-save-btn:hover{background-color:#39ff94}
        #modal-save-btn:active{transform:scale(.98)}
        #topic-plan-modal{max-width:900px;z-index:1001;background-color:var(--bg-color)}
        #topic-plan-modal .modal-header h2{color:var(--vfd-green);font-size:1.3em}
        #topic-plan-modal .modal-content{padding:15px 25px}
        .study-flow-diagram{display:flex;flex-direction:column;gap:15px;width:100%}
        .step-card{border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.3);padding:12px 18px;display:flex;align-items:flex-start;transition:opacity .3s ease,border-left-color .3s ease;border-left-style:solid;border-left-width:5px;background-color:var(--plan-bg)}
        .step-card.completed{border-left-color:#505050!important;opacity:.65}
        .step-card.completed .step-icon-container,.step-card.completed .step-title,.step-card.completed .step-details li{color:#909090!important}
        .step-card.completed .step-number{background-color:#383838!important;color:#787878!important}
        .step-icon-container{font-size:1.8em;margin-right:15px;padding-top:2px;min-width:35px;text-align:center}
        .step-content{flex-grow:1}
        .step-title{font-size:1.2em;font-weight:600;margin:0 0 10px;display:flex;align-items:center;color:var(--text-color)}
        .step-title .subtitle{font-size:.7em;color:#999;margin-left:8px;font-weight:400;text-transform:none}
        .step-number{color:#101010;border-radius:50%;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;font-size:.7em;font-weight:bold;margin-right:8px;flex-shrink:0}
        .step-details{list-style:none;padding-left:0;margin:0}
        .step-details li{margin-bottom:8px;font-size:.9em;line-height:1.4;display:flex;align-items:center;color:var(--meta-text)}
        .step-details li label{display:flex;align-items:center;cursor:pointer;width:100%}
        .task-checkbox{margin-right:10px;accent-color:var(--vfd-green);transform:scale(1.1)}
        .task-text{transition:text-decoration .3s ease,color .3s ease}
        input[type=checkbox]:checked+label .task-text,input[type=checkbox]:checked~.task-text{text-decoration:line-through;color:#6a6a6a}
        .optional-tag{font-size:.8em;color:#888;margin-left:5px;font-style:italic}
        .tool-tag{padding:2px 8px;border-radius:12px;font-size:.75em;font-weight:600;margin-left:8px;border:1px solid}
        .tag-madera{background-color:#c8e6c9;color:var(--tag-text-dark);border-color:#a5d6a7}
        .tag-ia{background-color:#bbdefb;color:var(--tag-text-dark);border-color:#90caf9}
        .tag-genspark{background-color:#ffecb3;color:var(--tag-text-dark);border-color:#ffe082}
        .tag-notebooklm{background-color:#d1c4e9;color:var(--tag-text-dark);border-color:#b39ddb}
        .step-1{border-left-color:var(--step-1-color)}
        .step-1 .step-icon-container{color:var(--step-1-color)}
        .step-1 .step-number{background-color:var(--step-1-color)}
        .step-2{border-left-color:var(--step-2-color)}
        .step-2 .step-icon-container{color:var(--step-2-color)}
        .step-2 .step-number{background-color:var(--step-2-color)}
        .step-3{border-left-color:var(--step-3-color)}
        .step-3 .step-icon-container{color:var(--step-3-color)}
        .step-3 .step-number{background-color:var(--step-3-color)}
        .step-4{border-left-color:var(--step-4-color)}
        .step-4 .step-icon-container{color:var(--step-4-color)}
        .step-4 .step-number{background-color:var(--step-4-color)}
        .step-5{border-left-color:var(--step-5-color)}
        .step-5 .step-icon-container{color:var(--step-5-color)}
        .step-5 .step-number{background-color:var(--step-5-color)}
        .step-6{border-left-color:var(--step-6-color)}
        .step-6 .step-icon-container{color:var(--step-6-color)}
        .step-6 .step-number{background-color:var(--step-6-color)}
        .parallel-steps-container{display:flex;gap:15px}
        .parallel-steps-container .step-card{flex:1}
        .practice-step-layout{display:flex;flex-direction:row;gap:15px;width:100%}
        .practice-tasks-column{flex:2}
        .practice-score-column{flex:1}
        .practice-score-column h3{font-size:.9em;color:#ccc;margin:0 0 8px;font-weight:500;text-transform:uppercase}
        .score-inputs-row{display:flex;gap:8px}
        .score-input-group{flex-grow:1}
        .score-input-group label{font-size:.75em;color:#bbb}
        .score-input-group input{font-family:'Source Sans Pro',sans-serif;background-color:#2a2a2a;color:#e0e0e0;border:1px solid #444;border-radius:4px;padding:5px 8px;font-size:.9em;width:100%;box-sizing:border-box;text-align:center}
        .score-input-group input[type=number]::-webkit-inner-spin-button,.score-input-group input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
        .score-input-group input[type=number]{-moz-appearance:textfield}
        .percentage-output{font-weight:bold;background-color:var(--plan-bg)!important;cursor:default}
        .topic-modal-footer{margin-top:25px;padding-top:15px;border-top:1px solid var(--main-border);text-align:right}
        .topic-finish-btn{background-color:var(--vfd-green);color:var(--bg-color);border:none;border-radius:6px;padding:12px 25px;font-family:'Orbitron',sans-serif;font-size:1em;font-weight:700;text-transform:uppercase;cursor:pointer;transition:background-color .2s ease,transform .2s ease}
        .topic-finish-btn:hover{background-color:#76ff76;transform:translateY(-2px)}
        @media (max-width:768px){.motivational-quote{font-size:1.2em}.countdown-digits{font-size:3em}.countdown-timer-container{gap:15px}.parallel-steps-container,.practice-step-layout,.kanban-board{flex-direction:column;display:block}.kanban-column{margin-bottom:20px}.day-cell{min-height:120px}}
        @media (max-width:600px){.banner-bottom-row{flex-direction:column;align-items:stretch}.auth-container{justify-content:space-between}.motivational-quote{font-size:1em;letter-spacing:1px}.countdown-digits{font-size:2.2em}.countdown-label{font-size:.6em}.countdown-timer-container{gap:10px}body{padding:0}.view-wrapper{padding:10px}.calendar-container{grid-template-columns:30px 30px repeat(7,1fr)}.modal-content{padding:15px}.step-card{flex-direction:column}.step-icon-container{text-align:left;margin-bottom:5px}#edit-countdown-btn{right:-5px;top:-15px}}
    </style>
</head>
<body>
    <header class="app-banner">
        <div id="motivational-quote-container" class="motivational-quote"></div>
        <div class="countdown-container">
            <div class="countdown-timer-container">
                <div class="countdown-unit"><div class="countdown-label">Days</div><div class="countdown-digits" id="countdown-days">000</div></div>
                <div class="countdown-unit"><div class="countdown-label">Hours</div><div class="countdown-digits" id="countdown-hours">00</div></div>
                <div class="countdown-unit"><div class="countdown-label">Minutes</div><div class="countdown-digits" id="countdown-minutes">00</div></div>
                <div class="countdown-unit"><div class="countdown-label">Seconds</div><div class="countdown-digits" id="countdown-seconds">00</div></div>
            </div>
            <button id="edit-countdown-btn" title="Editar fecha final"><i class="fas fa-calendar-alt"></i></button>
        </div>
        <div id="countdown-editor">
            <input type="date" id="countdown-date-picker">
            <button id="save-countdown-btn">Guardar</button>
        </div>
        <div class="banner-bottom-row">
            <div class="global-progress-container">
                <div class="progress-bar-wrapper">
                    <label id="global-score-label">Puntuación Global (Promedio de Calificaciones)</label>
                    <div class="progress-bar-background"><div class="progress-bar-fill" id="global-score-bar" role="progressbar">0%</div></div>
                </div>
                <div class="progress-bar-wrapper">
                    <label id="global-advance-label">Avance Global (Temas Completados)</label>
                    <div class="progress-bar-background"><div class="progress-bar-fill" id="global-advance-bar" role="progressbar">0%</div></div>
                </div>
            </div>
            <button id="view-switcher" class="view-switcher" data-current-view="calendar">
                <i class="fas fa-columns"></i> Tablero Vital
            </button>
             <div id="auth-container" style="display: flex; align-items: center; gap: 15px; flex-shrink: 0;">
                <span id="user-display" style="font-weight: 600; display: none; color: var(--text-color);"></span>
                <button id="auth-btn" class="view-switcher" style="background-color: #4A90E2;"><i class="fab fa-google" style="margin-right: 8px;"></i>Login</button>
            </div>
        </div>
    </header>

    <main class="main-content-area">
        <div id="calendar-view" class="view-wrapper">
            <div class="calendar-container" id="calendar-container"></div>
        </div>
        <div id="board-view" class="view-wrapper hidden">
            <main class="kanban-board">
                <section class="kanban-column" id="col-todo"><div class="kanban-column-header"><h2><i class="far fa-circle" style="margin-right: 8px;"></i>Sin Empezar</h2></div><div class="cards-container" id="col-todo-container"></div></section>
                <section class="kanban-column" id="col-inprogress"><div class="kanban-column-header"><h2><i class="fas fa-spinner" style="margin-right: 8px;"></i>En Curso</h2></div><div class="cards-container" id="col-inprogress-container"></div></section>
                <section class="kanban-column" id="col-done"><div class="kanban-column-header"><h2><i class="fas fa-check-circle" style="margin-right: 8px;"></i>Listo</h2></div><div class="cards-container" id="col-done-container"></div></section>
            </main>
        </div>
    </main>
    
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-container" id="details-modal"><div class="modal-header"> <h2 id="modal-title"></h2> <span class="modal-close" id="modal-close-day">×</span> </div><div class="modal-content"> <div id="modal-topics"></div> <div class="notes-section" style="margin-top: 20px;"> <h3>Mis Anotaciones del Día</h3> <textarea id="modal-notes" placeholder="Escribe aquí tus notas generales para este día..."></textarea> <button id="modal-save-btn">Guardar Nota</button> </div> </div></div>
    <div class="modal-overlay" id="topic-plan-overlay"></div>
    <div class="modal-container" id="topic-plan-modal"><div class="modal-header"> <h2 id="topic-plan-title"></h2> <span class="modal-close" id="modal-close-topic">×</span> </div><div class="modal-content"><div class="study-flow-diagram"><div class="step-card step-1"> <div class="step-icon-container"><i class="fas fa-binoculars"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">1</span>VISTA RÁPIDA</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-1-1"><i class="fas fa-list-ul task-icon"></i><span class="task-text">Índice</span><span class="tool-tag tag-madera">MADERA</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-1-2"><i class="fas fa-download task-icon"></i><span class="task-text">Descargar guías</span><span class="optional-tag">* opcional</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-1-3"><i class="fas fa-brain task-icon"></i><span class="task-text">CREA resúmenes + casos con IA (5min)</span><span class="tool-tag tag-ia">IAGOOGLE</span></label></li> </ul> </div> </div><div class="parallel-steps-container"> <div class="step-card step-2"> <div class="step-icon-container"><i class="fas fa-magic"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">2</span>CREAR</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-2-1"><i class="fas fa-chalkboard-teacher task-icon"></i><span class="task-text">Presentación</span><span class="tool-tag tag-genspark">Genspark</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-2-2"><i class="fas fa-microphone-alt task-icon"></i><span class="task-text">Podcast MP3</span><span class="tool-tag tag-notebooklm">NOTEBOOKLM</span></label></li> </ul> </div> </div> <div class="step-card step-3"> <div class="step-icon-container"><i class="fas fa-book-reader"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">3</span>LEER</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-3-1"><i class="fas fa-file-alt task-icon"></i><span class="task-text">Leer Resumen</span></label></li> </ul> </div> </div> </div><div class="step-card step-4"> <div class="step-icon-container"><i class="fas fa-puzzle-piece"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">4</span>UNIFICAR<span class="subtitle">(resumen + presentación + simular + enlaces)</span></h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-4-1"><i class="fas fa-code task-icon"></i><span class="task-text">HTML</span><span class="tool-tag tag-ia">IAGOOGLE</span></label></li> </ul> </div> </div><div class="step-card step-5"> <div class="step-icon-container"><i class="fas fa-tasks"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">5</span>PRACTICAR</h2> <div class="practice-step-layout"> <div class="practice-tasks-column"> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-5-1"><i class="fas fa-notes-medical task-icon"></i><span class="task-text">Realiza CASOS CLÍNICOS</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-5-2"><i class="fas fa-redo-alt task-icon"></i><span class="task-text">Repasar</span><span class="tool-tag tag-genspark">GENSPARK</span><span class="tool-tag tag-madera">MADERAS</span></label></li> </ul> </div> <div class="practice-score-column"> <h3>PUNTUACIÓN</h3> <div class="score-inputs-row"> <div class="score-input-group"><label for="score-aciertos">Aciertos:</label><input type="number" id="score-aciertos" min="0"></div> <div class="score-input-group"><label for="score-reactivos">Reactivos:</label><input type="number" id="score-reactivos" min="0"></div> <div class="score-input-group"><label for="score-percentage">%:</label><input type="text" id="score-percentage" class="percentage-output" readonly value="0%"></div> </div> </div> </div> </div> </div><div class="step-card step-6"> <div class="step-icon-container"><i class="fas fa-head-side-headphones"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">6</span>MEMORIZAR</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-6-1"><i class="fas fa-headphones-alt task-icon"></i><span class="task-text">Escuchar MP3</span></label></li> </ul> </div> </div></div><div class="topic-modal-footer"> <button id="topic-finish-btn" class="topic-finish-btn">Terminar Tema</button> </div></div></div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const firebaseConfig = {
          apiKey: "AIzaSyCCiJerwL3i9JcCcBz6c1JWqHSBUL7ReCU",
          authDomain: "plan75-d8119.firebaseapp.com",
          projectId: "plan75-d8119",
          storageBucket: "plan75-d8119.appspot.com",
          messagingSenderId: "87701025627",
          appId: "1:87701025627:web:58d4cd9778a90a4c14e07e"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null;

        const subjectToTopicsMap = new Map();
        const motivationalQuotes = [ "La disciplina es el puente entre metas y logros.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "No te detengas hasta que te sientas orgulloso.", "Cree en ti mismo y todo será posible.", "El único modo de hacer un gran trabajo es amar lo que haces." ];
        
        const rentableTopics = new Set([
            "Fiebre reumática","Pericarditis","Endocarditis infecciosa","Infarto agudo de miocardio","Enfermedad coronaria","Disección aórtica","Aneurisma aórtico abdominal","Cor pulmonar crónico","Edema pulmonar","Hipotensión ortostática",
            "Estenosis aórtica","Insuficiencia aórtica","Estenosis mitral","Insuficiencia mitral","Hipertensión arterial sistémica","Crisis hipertensivas","Hipertensión pulmonar","Insuficiencia cardíaca aguda","Insuficiencia cardíaca crónica",
            "Enfermedad arterial periférica","Insuficiencia venosa","Pie diabético","Trombosis venosa profunda","Tromboembolia pulmonar","Úlceras por presión",
            "Soporte vital básico","RCP","Taquicardia ACLS","Taquicardia supraventricular","Bloqueos AV","Bradicardia","Fibrilación auricular","Síndrome de WPW",
            "Politrauma","Tipos de shock","Choque hipovolémico","Shock neurogénico","TCE adultos","TCE pediátrico","Fracturas de cráneo","Trauma torácico","Hemotórax","Neumotórax a tensión","Neumotórax aberto","Neumotórax simple","Taponamiento cardíaco","Trauma abdominal","Trauma esplénico","Trauma pélvico","Quemaduras","Gran quemado","Catéter venoso central","Hipotermia",
            "Manejo de intoxicaciones","Toxíndromes","Intoxicación por benzodiacepinas","Intoxicación por organofosforados","Intoxicación por paracetamol","Intoxicación por salicilatos","Intoxicación por etanol","Intoxicación por monóxido de carbono","Intoxicación por opiáceos","Ingesta de cáusticos","Anafilaxia","Picadura de alacrán","Mordedura de serpiente","Lactrodectus","Loxosceles","Golpe de calor",
            "Reflujo ERGE","Enfermedad ácido péptica","Síndrome de intestino irritable","Dispepsia funcional","Esófago de Barrett","Enfermedad celíaca","Enfermedad de Crohn","Colitis ulcerativa","Enfermedad diverticular","Sangrado TDA","Sangrado TDB","Varices esofágicas","EHGNA","Hepatitis A","Hepatitis B","Hepatitis C","Absceso hepático amebiano","Absceso hepático piógeno","Cirrosis hepática","Insuficiencia hepática","Ascitis","Encefalopatía hepática","Pancreatitis aguda","Pancreatitis crónica","Cáncer gástrico","Cáncer de esófago","Cáncer de páncreas","Carcinoma hepatocelular",
            "Apendicitis aguda","Apendicitis en el embarazo","Hernias","Hernia inguinal","Hernia femoral","Hernia hiatal","Hernia umbilical","Hernia ventral","Colecistitis aguda","Colelitiasis","Coledocolitiasis","Colangitis aguda","Oclusión intestinal","Vólvulo de sigmoides","Enfermedad hemorroidal","Fístula anal","Fisura anal","Absceso anal","Quiste pilonidal","Cáncer colorrectal","Heridas quirúrgicas",
            "Atresia esofágica","Atresia duodenal","Atresia yeyunoileal","Atresia biliar","Atresia de coanas","Estenosis pilórica","Hernia diafragmática congénita","Malrotación intestinal","Invaginación intestinal","Divertículo de Meckel","Hirschsprung","Enfermedad de Hirschsprung","Patología umbilical","Criptorquidia","Espina bífida","Malformaciones rectales","Retinoblastoma","Nefroblastoma","Neuroblastoma","Tumor abdominal",
            "Amenorreas primarias","Amenorreas secundarias","Sangrado uterino anormal","Dismenorrea aguda","Adenomiosis","Endometriosis","Miomatosis uterina","Hiperplasia endometrial","Quiste de ovario benigno","Torsión ovárica","Ovario poliquístico","Enfermedad pélvica inflamatoria","Vaginitis bacteriana","Vaginitis infecciosa","Tricomoniasis","Bartolinitis","Candidiasis vulvovaginal","Chlamydia","Mastitis","Mastopatía fibroquística","Fibroadenoma","Papiloma intraductal","Quiste mamario","Patología mamaria benigna","Osteoporosis post menopausia","Menopausia y climaterio","Insuficiencia ovárica primaria","Anticonceptivos generalidades","Anticonceptivos GPC","Anticonceptivos hormonales combinados","Anticoncepción de emergencia","DIU de cobre","DIU de levonorgestrel","Implante subdérmico","Progestágenos solos","Lactancia como anticonceptivo","Condón","Vasectomía","Oclusión tubaria bilateral OTB","Infertilidad","Cistocele e incontinencia",
            "Tamizaje cáncer de mama","Cáncer de mama","Cáncer cérvicouterino","Cáncer de endometrio","Cáncer de ovario","Cáncer de vagina","Tumores anexiales",
            "Control prenatal","Aloinmunización materna","Estática fetal","Tipos de pelvis","Atención del parto","Manejo activo del parto","Cesárea","Parto pretérmino","Puerperio fisiológico","Líquido amniótico","Ruptura prematura de membranas","Corioamnionitis","Distocias","Embarazo múltiple","Endometritis puerperal","Hiperémesis gravídica","Insuficiencia cervical","Muerte fetal","Enfermedades hipertensivas del embarazo","Preeclampsia sin datos de severidad","Síndrome de HELLP","Diabetes gestacional","IVU en el embarazo","Restricción del crecimiento intrauterino","Sepsis puerperal","Síndrome de Sheehan","Depresión posparto",
            "Generalidades de hemorragias","Hemorragia postparto","Desgarro perineal","Amenaza de aborto","Aborto espontáneo","Acretismo placentario","Atonía uterina","Choque hemorrágico en obstetricia","Desprendimiento prematuro de placenta normoinserta","Embarazo ectópico","Placenta previa","Ruptura uterina","Vasa previa","Enfermedad trofoblástica gestacional",
            "APGAR","Reanimación neonatal","Prematuro sano","Recién nacido de término","Apnea del prematuro","Asfixia neonatal","Síndrome de dificultad respiratoria","Taquipnea transitoria del recién nacido","Síndrome de aspiración de meconio","Displasia broncopulmonar","Silverman Anderson","Maduración pulmonar","Encefalopatía hipóxica","Enfermedad hemorrágica del recién nacido","Enterocolitis necrotizante","Hipoacusia neonatal","Hipoglucemia neonatal","Ictericia neonatal","Muerte súbita del lactante","Sepsis neonatal","Tamiz neonatal","Lesiones de plexo braquial obstétrico","Lesiones extracraneales","Displasia del desarrollo de la cadera DDC",
            "Cardiopatías congénitas","Tetralogía de Fallot","Coartación aórtica","Persistencia del conducto arterioso","Fibrosis quística","Fenilcetonuria","Galactosemia clásica","STORCH","STORCH Citomegalovirus","STORCH Herpes simple","STORCH Rubéola congénita","STORCH Sífilis congénita","STORCH Toxoplasmosis","STORCH Varicela congénita",
            "Control de niño sano","Etapas del crecimiento","Talla baja","Alergia alimentaria","Cuerpo extraño","Dermatitis del pañal","Estreñimiento funcional","Hiperplasia adrenal congénita","Hipotiroidismo congénito","Maltrato infantil","Mucopolisacaridosis","Reflujo gastroesofágico del lactante",
            "Lactancia materna","Alimentación complementaria","Desnutrición pediátrica","Deficiencia de vitamina A","Hipovitaminosis","Raquitismo carencial","Pelagra en niños","Intolerancia a la lactosa","Obesidad en escolares","Síndrome metabólico en niños",
            "Adenitis mesentérica","Onfalitis","Exantemáticas Diferencial","Eritema infeccioso","Escarlatina","Exantema súbito","Enfermedad de Kawasaki","Síndrome mano pie boca","Rubéola","Sarampión","Varicela","Parotiditis","Bronquiolitis","Epiglotitis","Laringotraqueitis CRUP","Mononucleosis infecciosa","Tos ferina","IVU en menores",
            "Vacunas generalidades","Tipos de vacunas","Vacunación universal","Aplicación de vacunas","Vacuna para personal de salud","Vacunas en el embarazo","Esquema de vacunación","BCG","Hepatitis A","Hepatitis B","Hexavalente","Influenza","Neumocócica","Rotavirus","Sabin","Salmonella","DPT","SRP","Tétanos","Varicela","VPH"
        ]);
        
        let userProgress = {};
        let studyPlan; 
        let countdownTargetDateStr;
        let countdownInterval = null;
        const ALL_TASK_IDS = ['task-1-1', 'task-1-2', 'task-1-3', 'task-2-1', 'task-2-2', 'task-3-1', 'task-4-1', 'task-5-1', 'task-5-2', 'task-6-1'];
        const PLAN_VERSION = 12; 
        
        let calendarView, boardView, viewSwitcher, calendarContainer, todoContainer, inprogressContainer, doneContainer;
        let dayModal, dayModalOverlay, dayModalTitle, dayModalTopicsContainer, dayModalNotes, saveNoteButton;
        let topicModal, topicModalOverlay, topicModalTitle, topicStepCards, topicTaskCheckboxes, aciertosInput, reactivosInput, percentageOutput, finishTopicButton;
        let globalScoreBar, globalAdvanceBar;
        let editCountdownBtn, countdownEditor, countdownDatePicker, saveCountdownBtn, quoteContainer;
        
        function assignDOMelements() {
            calendarView = document.getElementById('calendar-view');
            boardView = document.getElementById('board-view');
            viewSwitcher = document.getElementById('view-switcher');
            calendarContainer = document.getElementById('calendar-container');
            todoContainer = document.getElementById('col-todo-container');
            inprogressContainer = document.getElementById('col-inprogress-container');
            doneContainer = document.getElementById('col-done-container');
            dayModal = document.getElementById('details-modal');
            dayModalOverlay = document.getElementById('modal-overlay');
            dayModalTitle = document.getElementById('modal-title');
            dayModalTopicsContainer = document.getElementById('modal-topics');
            dayModalNotes = document.getElementById('modal-notes');
            saveNoteButton = document.getElementById('modal-save-btn');
            topicModal = document.getElementById('topic-plan-modal');
            topicModalOverlay = document.getElementById('topic-plan-overlay');
            topicModalTitle = document.getElementById('topic-plan-title');
            topicStepCards = topicModal.querySelectorAll('.step-card');
            topicTaskCheckboxes = topicModal.querySelectorAll('.task-checkbox');
            aciertosInput = document.getElementById('score-aciertos');
            reactivosInput = document.getElementById('score-reactivos');
            percentageOutput = document.getElementById('score-percentage');
            finishTopicButton = document.getElementById('topic-finish-btn');
            globalScoreBar = document.getElementById('global-score-bar');
            globalAdvanceBar = document.getElementById('global-advance-bar');
            editCountdownBtn = document.getElementById('edit-countdown-btn');
            countdownEditor = document.getElementById('countdown-editor');
            countdownDatePicker = document.getElementById('countdown-date-picker');
            saveCountdownBtn = document.getElementById('save-countdown-btn');
            quoteContainer = document.getElementById('motivational-quote-container');
        }

        function saveData(key, value) {
            if (!currentUser) return;
            const keys = key.split('.');
            let currentLocal = userProgress;
            for (let i = 0; i < keys.length - 1; i++) {
                currentLocal = currentLocal[keys[i]] = currentLocal[keys[i]] || {};
            }
            currentLocal[keys[keys.length - 1]] = value;
            clearTimeout(window.saveTimeout);
            window.saveTimeout = setTimeout(() => {
                db.collection('userProgress').doc(currentUser.uid).set({ progressData: userProgress }, { merge: true })
                  .catch(error => console.error("Error al sincronizar:", error));
            }, 1500);
        }

        async function loadProgressFromFirestore() {
            if (!currentUser) return;
            const docRef = db.collection('userProgress').doc(currentUser.uid);
            const doc = await docRef.get();
            if (doc.exists && doc.data().progressData) {
                userProgress = doc.data().progressData;
            } else {
                userProgress = {};
            }
            
            const dataUpdated = migrateInitialProgress();

            const savedPlanVersion = getData('planVersion', 1);
            studyPlan = getData('studyPlan');

            if (!studyPlan || savedPlanVersion < PLAN_VERSION) {
                studyPlan = generateStudyPlan();
                saveData('studyPlan', studyPlan);
                saveData('planVersion', PLAN_VERSION);
            }

            countdownTargetDateStr = getData('countdownTarget', '2025-09-23');
            countdownDatePicker.value = countdownTargetDateStr;

            if (dataUpdated) {
                 db.collection('userProgress').doc(currentUser.uid).set({ progressData: userProgress }, { merge: true })
                  .catch(error => console.error("Error al sincronizar datos migrados:", error));
            }

            startCountdown();
            populateCalendar();
            updateGlobalProgressBars();
        }

        function migrateInitialProgress() {
            const initialData = {
                "ENDOCRINOLOGÍA": {
                    "Nódulo tiroideo": {aciertos: 5, reactivos: 9}, "Ca tiroides": {aciertos: 5, reactivos: 9}, "Hipotiroidismo": {aciertos: 86, reactivos: 100}, "Hipertiroidismo": {aciertos: 58, reactivos: 100},
                    "Dislipidemias": {aciertos: 4, reactivos: 9}, "Obesidad": {aciertos: 6, reactivos: 9}, "E. Addison": {aciertos: 6, reactivos: 9}, "Sx Metabólico": {aciertos: 8, reactivos: 9},
                    "Diabetes mellitus": {aciertos:12,reactivos:15}, "Prediabetes": {aciertos:15,reactivos:15}, "Diabetes en el adulto mayor": {aciertos:6,reactivos:9}, "Diabetes en pediatría": {aciertos:5,reactivos:9}, "Cetoacidosis diabética y EHH": {aciertos:13,reactivos:18}, "Hipoglucemia": {aciertos:6,reactivos:9}, "Enfermedad de Cushing / Síndrome de Cushing": {aciertos:0,reactivos:0}, "Hiperprolactinemia": {aciertos:0,reactivos:0}, "Acromegalia": {aciertos:0,reactivos:0}, "Feocromocitoma": {aciertos:0,reactivos:0}, "Hiperaldosteronismo": {aciertos:0,reactivos:0}, "Hiperparatiroidismo": {aciertos:0,reactivos:0}, "Neoplasia endocrina múltple": {aciertos:0,reactivos:0}, "Alopecia endocrina": {aciertos:0,reactivos:0} 
                },
                "ORL": { "Epistaxis": {aciertos: 8, reactivos: 9}, "VPPB": {aciertos: 9, reactivos: 9}, "Parálisis de Bell": {aciertos: 6, reactivos: 9}, "Neuralgia de trigémino": {aciertos: 1, reactivos: 14}, "Neuritis vestibular": {aciertos: 6, reactivos: 9}, "Fracturas nasales": {aciertos: 8, reactivos: 9}, "Rinosinusitis": {aciertos: 6, reactivos: 9}, "Faringoamigdalitis": {aciertos: 6, reactivos: 9}, "Angina de Ludwig": {aciertos: 6, reactivos: 9}, "Otitis": {aciertos: 7, reactivos: 9}, "Mastoiditis aguda": {aciertos: 5, reactivos: 9} },
                "OFTALMOLOGÍA": { "Blefaritis": { aciertos: 5, reactivos: 9 }, "Orzuelo": { aciertos: 6, reactivos: 9 }, "Conjuntivitis (alergica, bacteriana, neonatal, viral)": { aciertos: 16, reactivos: 21 }, "Chalazión": { aciertos: 9, reactivos: 9 }, "Glaucoma de ángulo aberto": { aciertos: 3, reactivos: 9 }, "Glaucoma de ángulo cerrado": { aciertos: 5, reactivos: 9 }, "Glaucoma congénito": { aciertos: 8, reactivos: 9 }, "Degeneración macular": { aciertos: 0, reactivos: 0 }, "Desprendimiento de retina": { aciertos: 0, reactivos: 0 }, "Retinopatía diabética": { aciertos: 4, reactivos: 9 }, "Retinopatía hipertensiva": { aciertos: 5, reactivos: 9 }, "Catarata": { aciertos: 7, reactivos: 9 }, "Trauma ocular": { aciertos: 15, reactivos: 18 }, "Ojo rojo": { aciertos: 7, reactivos: 9 } },
                "GENÉTICA": { "Síndrome de Down": {aciertos:0,reactivos:0}, "Síndrome de Klinefelter": {aciertos:0,reactivos:0}, "Síndrome de Turner": {aciertos:0,reactivos:0}, "Síndrome de Marfan": {aciertos:0,reactivos:0}, "Enfermedad de Wilson": {aciertos:0,reactivos:0}, "Síndrome de Dravet": {aciertos:0,reactivos:0}, "Síndrome de Lynch": {aciertos:0,reactivos:0}, "Síndrome de Peutz Jegher": {aciertos:0,reactivos:0}, "Von Hippel Lindau": {aciertos:0,reactivos:0} },
                "GERIATRÍA": { "Valoración geriátrica": {aciertos:18,reactivos:21}, "Alzheimer": {aciertos:12,reactivos:15}, "Delirium": {aciertos:7,reactivos:15}, "Demencia vascular": {aciertos:8,reactivos:9}, "Deterioro cognitivo": {aciertos:15,reactivos:21}, "Insomnio en el adulto mayor": {aciertos:9,reactivos:9}, "Síndrome de caídas": {aciertos:7,reactivos:9}, "Síndrome de fragilidad": {aciertos:15,reactivos:21}, "Maltrato en el adulto mayor": {aciertos:8,reactivos:9}, "Colapso del cuidador": {aciertos:15,reactivos:21}, "Depresión mayor": {aciertos:9,reactivos:9} },
                "PSIQUIATRÍA": { "Abuso de sustancias": {aciertos:11,reactivos:15}, "Abstinencia alcohólica": {aciertos:12,reactivos:12}, "Trastorno por alcohol": {aciertos:9,reactivos:15}, "Esquizofrenia": {aciertos:10,reactivos:15}, "Estrés post traumático": {aciertos:3,reactivos:9}, "Trastornos del sueño": {aciertos:10,reactivos:15}, "Intento de suicidio": {aciertos:8,reactivos:9}, "Tdah": {aciertos:8,reactivos:12}, "Trastorno bipolar": {aciertos:13,reactivos:15}, "Trastornos de ansiedad": {aciertos:10,reactivos:15}, "Trastornos de conducta alimentaria": {aciertos:13,reactivos:15}, "Consumo de mariguana": {aciertos:14,reactivos:15}, "Violencia contra la mujer": {aciertos:12,reactivos:15}, "Autismo": {aciertos:8,reactivos:9}, "Síndrome de Munchausen": {aciertos:8,reactivos:9}},
                "DERMATOLOGÍA": { "Dermatitis atópica": {aciertos:18,reactivos:18}, "Dermatofitosis": {aciertos:16,reactivos:18}, "SSJ y NET": {aciertos:12,reactivos:12}, "Escabiosis - Sarna": {aciertos:12,reactivos:12}, "Impétigo": {aciertos:7,reactivos:12}, "Melanoma": {aciertos:8,reactivos:12}, "Psoriasis": {aciertos:8,reactivos:12}, "Carcinoma basocelular": {aciertos:10,reactivos:12}, "Acné vulgar": {aciertos:9,reactivos:9}, "Erisipela": {aciertos:7,reactivos:9}, "Urticaria": {aciertos:7,reactivos:9}, "Dermatitis por contacto": {aciertos:6,reactivos:9}, "Pediculosis capitis": {aciertos:11,reactivos:12}, "Síndrome de Ritter": {aciertos:10,reactivos:12}, "Carcinoma espinocelular": {aciertos:9,reactivos:12} },
                "NEFROLOGÍA": { "Lesión renal aguda": {aciertos:7,reactivos:12}, "Enfermedad renal crónica": {aciertos:10,reactivos:12}, "Nefropatía diabética": {aciertos:7,reactivos:12}, "Síndrome nefrítico y nefrootico": {aciertos:17,reactivos:24}, "Trastorno ácido-base": {aciertos:11,reactivos:12}, "Nefritis lúpica": {aciertos:9,reactivos:12} },
                "REUMATOLOGÍA": { "Artritis reactiva": {aciertos:8,reactivos:12}, "Artritis reumatoide": {aciertos:10,reactivos:15}, "Espondilitis anquilosante": {aciertos:11,reactivos:12}, "Gota": {aciertos:6,reactivos:12}, "Lupus eritematoso sistémico": {aciertos:12,reactivos:15}, "Arteritis de la temporal": {aciertos:9,reactivos:9}, "Granulomatosis de Wegener": {aciertos:6,reactivos:9}, "Artritis séptica": {aciertos:9,reactivos:12} },
                "NEUMOLOGÍA": { "Asma en pediátricos": {aciertos:11,reactivos:21}, "Exacerbación de asma": {aciertos:8,reactivos:9}, "Cáncer de pulmón": {aciertos:4,reactivos:12}, "Epoc": {aciertos:3,reactivos:12}, "Derrame pleural": {aciertos:10,reactivos:12}, "Tabaquismo": {aciertos:5,reactivos:9} },
                "NEUROLOGÍA": { "Cefalea Secundarias": {aciertos:12,reactivos:12}, "Cefaleas primarias": {aciertos:9,reactivos:12}, "Crisis convulsivas": {aciertos:4,reactivos:12}, "Estatus epiléptico": {aciertos:9,reactivos:12}, "Crisis febriles": {aciertos:5,reactivos:12}, "Enfermedad de Parkinson": {aciertos:6,reactivos:9}, "Evc isquémico": {aciertos:10,reactivos:12}, "Hemorragia subaracnoidea": {aciertos:9,reactivos:9}, "Guillain Barré": {aciertos:8,reactivos:9}, "Esclerosis múltiple": {aciertos:5,reactivos:12}, "Evc hemorrágico": {aciertos:6,reactivos:12}, "Miastenia gravis": {aciertos:5,reactivos:9}, "Muerte encefálica": {aciertos:6,reactivos:9} },
                "HEMATOLOGÍA": { "Anemia generalidades": {aciertos:8,reactivos:18}, "Anemia ferropénica Adultos": {aciertos:8,reactivos:12}, "Leucemias": {aciertos:8,reactivos:12}, "Linfomas": {aciertos:10,reactivos:15}, "Trombocitopenia inmune": {aciertos:5,reactivos:9} },
                "INFECTOLOGÍA": { "Brucelosis": {aciertos:3,reactivos:3}, "Cisticercosis": {aciertos:7,reactivos:9}, "Clostridium": {aciertos:8,reactivos:9}, "Diarrea aguda en adultos": {aciertos:9,reactivos:12}, "Diarrea en niños": {aciertos:10,reactivos:12}, "Chinkungunya": {aciertos:7,reactivos:9}, "Dengue": {aciertos:6,reactivos:9}, "Zika": {aciertos:8,reactivos:9}, "Paludismo": {aciertos:7,reactivos:9}, "Salmonella Fiebre tifoidea": {aciertos:7,reactivos:9}, "Sepsis y choque séptico": {aciertos:7,reactivos:9}, "Tuberculosis pulmonar": {aciertos:14,reactivos:21}, "ETS Generalidades": {aciertos:14,reactivos:18}, "VIH Adultos": {aciertos:16,reactivos:21}, "VIH Madre e hijo": {aciertos:17,reactivos:21}, "RV yOportunistas": {aciertos:14,reactivos:21}, "Sarcoma de Kaposi": {aciertos:6,reactivos:9}, "Giardiasis": {aciertos:8,reactivos:9}, "Tuberculosis extrapulmonar": {aciertos:10,reactivos:12}, "Lepra": {aciertos:5,reactivos:9}, "Medios de cultivo": {aciertos:5,reactivos:9}, "Actinomicosis": {aciertos:6,reactivos:9}, "Amebiasis intestinal": {aciertos:7,reactivos:9}, "Anquilostomiasis": {aciertos:9,reactivos:9}, "Ascariasis": {aciertos:9,reactivos:9}, "Aspergilosis": {aciertos:7,reactivos:9}, "Coccidioidomicosis": {aciertos:8,reactivos:9}, "Difteria": {aciertos:9,reactivos:9}, "Enfermedad de Chagas": {aciertos:7,reactivos:9}, "Enfermedad de Lyme": {aciertos:7,reactivos:9}, "Estrongiloidiasis": {aciertos:7,reactivos:9}, "Fascitis necrosante": {aciertos:7,reactivos:9}, "Fiebre de origen desconocido": {aciertos:5,reactivos:9}, "Filariasis linfática": {aciertos:4,reactivos:9}, "Filariasis ocular Loasis": {aciertos:7,reactivos:9}, "Infecciones odontogénicas": {aciertos:6,reactivos:9}, "Leishmaniasis": {aciertos:7,reactivos:9}, "Leptospirosis": {aciertos:8,reactivos:9}, "Mucormicosis": {aciertos:9,reactivos:9}, "Oncocercosis": {aciertos:7,reactivos:9}, "Oxiuriasis o enterobiasis": {aciertos:5,reactivos:9}, "Poliomielitis": {aciertos:8,reactivos:9}, "Rabia": {aciertos:7,reactivos:9}, "Tricuriasis": {aciertos:9,reactivos:9}, "Triquinosis": {aciertos:8,reactivos:9}, "Neumonía adquirida en la comunidad": {aciertos:3,reactivos:12}, "Neumonía bacteriana adquirida en la comunidad Niños": {aciertos:7,reactivos:12}, "Influenza": {aciertos:6,reactivos:9}, "Meningitis": {aciertos:10,reactivos:12}, "Encefalitis viral": {aciertos:8,reactivos:9}, "Absceso cerebral": {aciertos:8,reactivos:9} },
                "UROLOGÍA": { "Escroto agudo": {aciertos:0,reactivos:0}, "Torsión testicular": {aciertos:0,reactivos:0}, "Hiperplasia prostática benigna": {aciertos:0,reactivos:0}, "Cáncer de próstata": {aciertos:0,reactivos:0}, "Pielonefritis aguda": {aciertos:0,reactivos:0}, "Infección de tracto urinario": {aciertos:0,reactivos:0}, "Urolitiasis": {aciertos:0,reactivos:0}, "Orquiepididimitis": {aciertos:0,reactivos:0}, "Cáncer testicular": {aciertos:0,reactivos:0}, "Disfunción eréctil": {aciertos:0,reactivos:0}, "Estenosis del meato urinario": {aciertos:0,reactivos:0}, "Hidrocele": {aciertos:0,reactivos:0}, "Varicocele": {aciertos:0,reactivos:0}, "Prostatitis aguda": {aciertos:0,reactivos:0}, "Cáncer de vejiga": {aciertos:0,reactivos:0}, "Cáncer renal": {aciertos:0,reactivos:0}, "Incontinencia urinaria": {aciertos:0,reactivos:0}, "Retención aguda de orina": {aciertos:0,reactivos:0} },
                "TYO": { "Osteoartritis": {aciertos:83, reactivos:100}, "Osteomielitis": {aciertos:67, reactivos:100}, "Sarcoma de Ewing": {aciertos:78, reactivos:100}, "Tumores óseos malignos": {aciertos:67, reactivos:100}, "Embolia grasa": {aciertos:78, reactivos:100}, "Lumbalgia": {aciertos:89, reactivos:100}, "Hernia de disco": {aciertos:56, reactivos:100}, "Síndrome de hombro doloroso": {aciertos:44, reactivos:100}, "Fractura de clavícula": {aciertos:67, reactivos:100}, "Fractura de húmero proximal": {aciertos:67, reactivos:100}, "Luxación glenohumeral": {aciertos:89, reactivos:100}, "Luxación de codo": {aciertos:53, reactivos:100}, "Fracturas de codo": {aciertos:60, reactivos:100}, "Fracturas de antebrazo": {aciertos:89, reactivos:100}, "Fractura de radio distal": {aciertos:78, reactivos:100}, "Lesiones fisiarias": {aciertos:78, reactivos:100}, "Fracturas expuestas": {aciertos:56, reactivos:100}, "Fractura de cadera": {aciertos:67, reactivos:100}, "Legg Calvé Perthes": {aciertos:67, reactivos:100}, "Luxación coxofemoral": {aciertos:78, reactivos:100}, "Fractura de diáfisis de tibia": {aciertos:33, reactivos:100}, "Fractura de tobillo": {aciertos:67, reactivos:100} },
                "CARDIOLOGÍA": { "Fiebre reumática": {aciertos:67, reactivos:100}, "Aneurisma aórtico abdominal": {aciertos:44, reactivos:100}, "Pericarditis": {aciertos:78, reactivos:100}, "Endocarditis infecciosa": {aciertos:56, reactivos:100}, "Enfermedad coronaria": {aciertos:89, reactivos:100}, "Cor pulmonar crónico": {aciertos:56, reactivos:100}, "Hipotensión ortostática": {aciertos:67, reactivos:100} }
            };

            let dataWasUpdated = false;
            if (!userProgress.topicData) {
                userProgress.topicData = {};
            }

            for (const specialty in initialData) {
                for (const topic in initialData[specialty]) {
                    const topicId = generateTopicId(topic);
                    if (!userProgress.topicData[topicId]) {
                        dataWasUpdated = true;
                        const data = initialData[specialty][topic];
                        userProgress.topicData[topicId] = {
                            scoreAciertos: data.aciertos,
                            scoreReactivos: data.reactivos,
                        };
                        // Marcar todas las tareas como completadas si hay una puntuación
                        if (data.aciertos > 0 || data.reactivos > 0) {
                             userProgress.topicData[topicId]['task-5-1'] = true;
                             userProgress.topicData[topicId]['task-5-2'] = true;
                        }
                    }
                }
            }
            return dataWasUpdated;
        }
        
        function recalculateFirstOfSubjectFlags(plan) {
            const subjectsFound = new Set();
            plan.forEach(day => {
                if (day.topicsList) {
                    day.topicsList.forEach(topic => {
                        if(topic.structureType === 'object') {
                            if (subjectsFound.has(topic.subject)) {
                                topic.isFirstOfSubject = false;
                            } else {
                                topic.isFirstOfSubject = true;
                                subjectsFound.add(topic.subject);
                            }
                        }
                    });
                }
                if (day.blocks) {
                     day.blocks.forEach(block => {
                        subjectsFound.add(block.subject);
                     });
                }
            });
        }

        function generateStudyPlan() {
            // Parte 1: Temas pre-julio (se mantienen igual, estructura original de `blocks`)
            const topicsBySpecialtyPart1 = {
                "UROLOGÍA": [ "Escroto agudo", "Torsión testicular", "Hiperplasia prostática benigna", "Cáncer de próstata", "Pielonefritis aguda", "Infección de tracto urinario", "Urolitiasis", "Orquiepididimitis", "Cáncer testicular", "Disfunción eréctil", "Estenosis del meato urinario", "Hidrocele", "Varicocele", "Prostatitis aguda", "Cáncer de vejiga", "Cáncer renal", "Incontinencia urinaria", "Retención aguda de orina" ], "ENDOCRINOLOGÍA": [ "Diabetes mellitus", "Prediabetes", "Diabetes en el adulto mayor", "Diabetes en pediatría", "Cetoacidosis diabética y EHH", "Hipoglucemia", "Enfermedad de Cushing / Síndrome de Cushing", "Hiperprolactinemia", "Acromegalia", "Feocromocitoma", "Hiperaldosteronismo", "Hiperparatiroidismo", "Neoplasia endocrina múltple", "Alopecia endocrina" ], "INFECTOLOGÍA": [ "Brucelosis", "Cisticercosis", "Clostridium", "Diarrea aguda en adultos", "Diarrea en niños", "Chinkungunya", "Dengue", "Zika", "Paludismo", "Salmonella Fiebre tifoidea", "Sepsis y choque séptico", "Tuberculosis pulmonar", "ETS Generalidades", "VIH Adultos", "VIH Madre e hijo", "RV yOportunistas", "Sarcoma de Kaposi", "Giardiasis", "Tuberculosis extrapulmonar", "Lepra", "Medios de cultivo", "Actinomicosis", "Amebiasis intestinal", "Anquilostomiasis", "Ascariasis", "Aspergilosis", "Coccidioidomicosis", "Difteria", "Enfermedad de Chagas", "Enfermedad de Lyme", "Estrongiloidiasis", "Fascitis necrosante", "Fiebre de origen desconocido", "Filariasis linfática", "Filariasis ocular Loasis", "Infecciones odontogénicas", "Leishmaniasis", "Leptospirosis", "Mucormicosis", "Oncocercosis", "Oxiuriasis o enterobiasis", "Poliomielitis", "Rabia", "Tricuriasis", "Triquinosis", "Neumonía adquirida en la comunidad", "Neumonía bacteriana adquirida en la comunidad Niños", "Influenza", "Meningitis", "Encefalitis viral", "Absceso cerebral" ], "HEMATOLOGÍA": [ "Anemia generalidades", "Anemia ferropénica Adultos", "Leucemias", "Linfomas", "Trombocitopenia inmune" ], "NEUROLOGÍA": [ "Cefalea Secundarias", "Cefaleas primarias", "Crisis convulsivas", "Estatus epiléptico", "Crisis febriles", "Enfermedad de Parkinson", "Evc isquémico", "Hemorragia subaracnoidea", "Guillain Barré", "Esclerosis múltiple", "Evc hemorrágico", "Miastenia gravis", "Muerte encefálica" ], "NEUMOLOGÍA": [ "Asma en pediátricos", "Exacerbación de asma", "Cáncer de pulmón", "Epoc", "Derrame pleural", "Tabaquismo" ], "REUMATOLOGÍA": [ "Artritis reactiva", "Artritis reumatoide", "Espondilitis anquilosante", "Gota", "Lupus eritematoso sistémico", "Arteritis de la temporal", "Granulomatosis de Wegener", "Artritis séptica" ], "NEFROLOGÍA": [ "Lesión renal aguda", "Enfermedad renal crónica", "Nefropatía diabética", "Síndrome nefrítico y nefrootico", "Trastorno ácido-base", "Nefritis lúpica" ], "DERMATOLOGÍA": [ "Dermatitis atópica", "Dermatofitosis", "SSJ y NET", "Escabiosis - Sarna", "Impétigo", "Melanoma", "Psoriasis", "Carcinoma basocelular", "Acné vulgar", "Erisipela", "Urticaria", "Dermatitis por contacto", "Pediculosis capitis", "Síndrome de Ritter", "Carcinoma espinocelular" ], "PSIQUIATRÍA": [ "Abuso de sustancias", "Abstinencia alcohólica", "Trastorno por alcohol", "Esquizofrenia", "Estrés post traumático", "Trastornos del sueño", "Intento de suicidio", "Tdah", "Trastorno bipolar", "Trastornos de ansiedad", "Trastornos de conducta alimentaria", "Consumo de mariguana", "Violencia contra la mujer", "Autismo", "Síndrome de Munchausen" ], "GERIATRÍA": [ "Valoración geriátrica", "Alzheimer", "Delirium", "Demencia vascular", "Deterioro cognitivo", "Insomnio en el adulto mayor", "Síndrome de caídas", "Síndrome de fragilidad", "Maltrato en el adulto mayor", "Colapso del cuidador", "Depresión mayor" ], "GENÉTICA": [ "Síndrome de Down", "Síndrome de Klinefelter", "Síndrome de Turner", "Síndrome de Marfan", "Enfermedad de Wilson", "Síndrome de Dravet", "Síndrome de Lynch", "Síndrome de Peutz Jegher", "Von Hippel Lindau" ]
            };
            
            let allTopicsToSchedulePart1 = [];
            Object.keys(topicsBySpecialtyPart1).reverse().forEach(specialty => { topicsBySpecialtyPart1[specialty].reverse().forEach(topic => { allTopicsToSchedulePart1.unshift({ specialty, topic }); }); });
            let plannedDaysPart1 = [];
            let currentDatePart1 = new Date('2025-06-30');
            while (allTopicsToSchedulePart1.length > 0) {
                currentDatePart1.setDate(currentDatePart1.getDate() - 1);
                if (currentDatePart1.toISOString().split('T')[0] === '2025-06-25') continue;
                const chunkSize = Math.min(allTopicsToSchedulePart1.length, Math.floor(Math.random() * (8 - 4 + 1)) + 4);
                const chunk = allTopicsToSchedulePart1.splice(0, chunkSize);
                const dayData = { date: currentDatePart1.toISOString().split('T')[0], blocks: [] };
                let lastSpecialty = null;
                chunk.forEach(item => { if (item.specialty !== lastSpecialty) { dayData.blocks.push({ subject: item.specialty, topics: [item.topic] }); lastSpecialty = item.specialty; } else { dayData.blocks[dayData.blocks.length - 1].topics.push(item.topic); } });
                plannedDaysPart1.push(dayData);
            }
            
            const endoDay = { date: "2025-06-25", blocks: [{ subject: "ENDOCRINOLOGÍA", topics: ["Nódulo tiroideo", "Ca tiroides", "Hipotiroidismo", "Hipertiroidismo", "Dislipidemias", "Obesidad", "E. Addison", "Sx Metabólico"] }] };
            const oftalmoDays = [ { date: "2025-06-30", blocks: [ { subject: "OFTALMOLOGÍA", topics: ["Blefaritis", "Orzuelo", "Conjuntivitis (alergica, bacteriana, neonatal, viral)", "Chalazión", "Glaucoma de ángulo aberto", "Glaucoma de ángulo cerrado", "Glaucoma congénito"] } ] }, { date: "2025-07-01", blocks: [ { subject: "OFTALMOLOGÍA", topics: ["Degeneración macular", "Desprendimiento de retina", "Retinopatía diabética", "Retinopatía hipertensiva", "Catarata", "Trauma ocular", "Ojo rojo"] } ] } ];
            const orlDays = [ { date: "2025-07-02", blocks: [ { subject: "ORL", topics: ["Epistaxis", "VPPB", "Parálisis de Bell", "Neuralgia de trigémino", "Neuritis vestibular", "Fracturas nasales"] } ] }, { date: "2025-07-03", blocks: [ { subject: "ORL", topics: ["Rinosinusitis", "Faringoamigdalitis", "Angina de Ludwig", "Otitis", "Mastoiditis aguda"] } ] } ];
            
            // Parte 2: Temas de Julio en adelante (nueva estructura de datos)
            const allNewTopicsBySpecialty = { 
                "TYO": [ "Osteoartritis", "Osteomielitis", "Osteosarcoma", "Sarcoma de Ewing", "Tumores óseos malignos", "Embolia grasa", "Costilla cervical", "Esguince cervical", "Lumbalgia", "Hernia de disco", "Túnel del carpo", "Síndrome de hombro doloroso", "Fractura de clavícula", "Fractura de húmero proximal", "Luxación glenohumeral", "Luxación de codo", "Codo de niñera", "Fracturas de codo", "Fracturas de antebrazo", "Fractura de radio distal", "Lesiones fisiarias", "Fracturas expuestas", "Fractura de cadera", "Epifisiolistesis femoral", "Legg Calvé Perthes", "Luxación coxofemoral", "Lesiones de rodilla", "Fractura de diáfisis de tibia", "Esguince de tobillo", "Fractura de tobillo", "Rotura de talón de Aquiles", "Pie equino varo", "Pie plano" ]
            };

            const manuallyScheduledDays = [
                // CARDIOLOGÍA
                { date: '2025-07-26', specialty: 'CARDIOLOGÍA', topics: ["Fiebre reumática", "Pericarditis", "Endocarditis infecciosa", "Infarto agudo de miocardio"] },
                { date: '2025-07-27', specialty: 'CARDIOLOGÍA', topics: ["Enfermedad coronaria", "Disección aórtica", "Aneurisma aórtico abdominal", "Cor pulmonar crónico"] },
                { date: '2025-07-28', specialty: 'CARDIOLOGÍA', topics: ["Edema pulmonar", "Hipotensión ortostática", "Rehabilitación cardíaca"] },
                // CARDIOLOGÍA II
                { date: '2025-07-29', specialty: 'CARDIOLOGÍA II', topics: ["Estenosis aórtica", "Insuficiencia aórtica", "Estenosis mitral", "Insuficiencia mitral", "Otras valvulopatías", "Hipertensión arterial sistémica"] },
                { date: '2025-07-30', specialty: 'CARDIOLOGÍA II', topics: ["Crisis hipertensivas", "Hipertensión pulmonar", "Insuficiencia cardíaca aguda", "Insuficiencia cardíaca crónica", "Enfermedad arterial periférica", "Insuficiencia venosa"] },
                // ANGIOLOGÍA
                { date: '2025-07-31', specialty: 'ANGIOLOGÍA', topics: ["Pie diabético", "Trombosis venosa profunda", "Tromboembolia pulmonar", "Paget Schroetter", "Tromboembolia venosa en obstetricia", "Úlceras por presión"] },
                // ACLS
                { date: '2025-08-01', specialty: 'ACLS', topics: ["Soporte vital básico", "RCP", "Taquicardia ACLS", "Taquicardia supraventricular", "Bloqueos AV", "Bradicardia"] },
                { date: '2025-08-02', specialty: 'ACLS', topics: ["Fibrilación auricular", "Fibrilación ventricular", "Síndrome de WPW", "PLS", "Ahogamiento", "Politrauma"] },
                // ATLS
                { date: '2025-08-03', specialty: 'ATLS', topics: ["Tipos de shock", "Choque hipovolémico", "Shock neurogénico", "TCE adultos", "TCE pediátrico", "Fracturas de cráneo"] },
                { date: '2025-08-04', specialty: 'ATLS', topics: ["Trauma torácico", "Hemotórax", "Neumotórax a tensión", "Neumotórax aberto", "Neumotórax simple", "Taponamiento cardíaco"] },
                { date: '2025-08-05', specialty: 'ATLS', topics: ["Lesión traqueobronquial", "Trauma abdominal", "Ruptura diafragmática", "Trauma esplénico", "Trauma espinal", "Trauma pélvico"] },
                { date: '2025-08-06', specialty: 'ATLS', topics: ["Trauma obstétrico", "Quemaduras", "Gran quemado", "Catéter venoso central", "Hipotermia", "Manejo de intoxicaciones"] },
                // TOXICOLOGÍA
                { date: '2025-08-07', specialty: 'TOXICOLOGÍA', topics: ["Toxíndromes", "Intoxicación por benzodiacepinas", "Intoxicación por organofosforados", "Intoxicación por paracetamol", "Intoxicación por salicilatos", "Intoxicación por etanol"] },
                { date: '2025-08-08', specialty: 'TOXICOLOGÍA', topics: ["Intoxicación por monóxido de carbono", "Intoxicación por opiáceos", "Intoxicación por anfetaminas", "Intoxicación por fentanilo", "Intoxicación por DMT", "Intoxicación por hidrocarburos"] },
                { date: '2025-08-09', specialty: 'TOXICOLOGÍA', topics: ["Intoxicación por metales pesados", "Intoxicación por plomo", "Intoxicación por alcoholes", "Ingesta de cáusticos", "Intoxicación alimentaria", "Anafilaxia"] },
                { date: '2025-08-10', specialty: 'TOXICOLOGÍA', topics: ["Picadura de alacrán", "Mordedura de serpiente", "Lactrodectus", "Loxosceles", "Picadura de himenópteros", "Golpe de calor"] },
                // GASTROENTEROLOGÍA
                { date: '2025-08-11', specialty: 'GASTROENTEROLOGÍA', topics: ["Reflujo ERGE", "Enfermedad ácido péptica", "Síndrome de intestino irritable", "Dispepsia funcional", "Mallory Weiss", "Zollinger Ellison"] },
                { date: '2025-08-12', specialty: 'GASTROENTEROLOGÍA', topics: ["Acalasia", "Esófago de Barrett", "Enfermedad celíaca", "Enfermedad de Crohn", "Colitis ulcerativa", "Enfermedad diverticular"] },
                { date: '2025-08-13', specialty: 'GASTROENTEROLOGÍA', topics: ["Sangrado TDA", "Sangrado TDB", "Varices esofágicas", "EHGNA", "Hepatitis A", "Hepatitis B"] },
                { date: '2025-08-14', specialty: 'GASTROENTEROLOGÍA', topics: ["Hepatitis C", "Hepatitis autoinmune", "Absceso hepático amebiano", "Absceso hepático piógeno", "Cirrosis hepática", "Insuficiencia hepática"] },
                { date: '2025-08-15', specialty: 'GASTROENTEROLOGÍA', topics: ["Ascitis", "Encefalopatía hepática", "Pancreatitis aguda", "Pancreatitis crónica", "Cáncer gástrico", "Cáncer de esófago"] },
                { date: '2025-08-16', specialty: 'GASTROENTEROLOGÍA', topics: ["Cáncer de páncreas", "Carcinoma hepatocelular", "Apendicitis aguda", "Apendicitis en el embarazo", "Hernias", "Hernia inguinal"] },
                // CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA
                { date: '2025-08-17', specialty: 'CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA', topics: ["Hernia femoral", "Hernia hiatal", "Hernia umbilical", "Hernia ventral", "Colecistitis aguda", "Colelitiasis"] },
                { date: '2025-08-18', specialty: 'CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA', topics: ["Coledocolitiasis", "Colangitis aguda", "Oclusión intestinal", "Isquemia intestinal", "Vólvulo de sigmoides", "Vólvulo de ciego"] },
                { date: '2025-08-19', specialty: 'CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA', topics: ["Enfermedad hemorroidal", "Fístula anal", "Fisura anal", "Absceso anal", "Quiste pilonidal", "Cáncer colorrectal"] },
                { date: '2025-08-20', specialty: 'CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA', topics: ["Poliposis adenomatosa familiar PAF", "Fístulas biliointestinales", "Colangiocarcinoma", "Complicaciones post Qx", "Heridas quirúrgicas", "Atresia esofágica"] },
                // CIRUGÍA PEDIÁTRICA
                { date: '2025-08-21', specialty: 'CIRUGÍA PEDIÁTRICA', topics: ["Atresia duodenal", "Atresia yeyunoileal", "Atresia biliar", "Atresia de coanas", "Estenosis pilórica", "Hernia diafragmática congénita"] },
                { date: '2025-08-22', specialty: 'CIRUGÍA PEDIÁTRICA', topics: ["Malrotación intestinal", "Invaginación intestinal", "Divertículo de Meckel", "Hirschsprung", "Enfermedad de Hirschsprung", "Patología umbilical"] },
                { date: '2025-08-23', specialty: 'CIRUGÍA PEDIÁTRICA', topics: ["Criptorquidia", "Espina bífida", "Malformaciones rectales", "Retinoblastoma", "Nefroblastoma", "Neuroblastoma", "Tumor abdominal"] },
                // GINECOLOGÍA
                { date: '2025-08-24', specialty: 'GINECOLOGÍA', topics: ["Amenorreas primarias", "Amenorreas secundarias", "Sangrado uterino anormal", "Dismenorrea aguda", "Adenomiosis", "Endometriosis"] },
                { date: '2025-08-25', specialty: 'GINECOLOGÍA', topics: ["Miomatosis uterina", "Hiperplasia endometrial", "Quiste de ovario benigno", "Torsión ovárica", "Ovario poliquístico", "Enfermedad pélvica inflamatoria"] },
                { date: '2025-08-26', specialty: 'GINECOLOGÍA', topics: ["Hidrosalpinx", "Fitz-Hugh-Curtis", "Vaginitis bacteriana", "Vaginitis infecciosa", "Tricomoniasis", "Bartolinitis"] },
                { date: '2025-08-27', specialty: 'GINECOLOGÍA', topics: ["Candidiasis vulvovaginal", "Chlamydia", "Mastitis", "Mastopatía fibroquística", "Fibroadenoma", "Papiloma intraductal"] },
                { date: '2025-08-28', specialty: 'GINECOLOGÍA', topics: ["Quiste mamario", "Patología mamaria benigna", "Osteoporosis post menopausia", "Menopausia y climaterio", "Insuficiencia ovárica primaria", "Anticonceptivos generalidades"] },
                { date: '2025-08-29', specialty: 'GINECOLOGÍA', topics: ["Anticonceptivos GPC", "Anticonceptivos hormonales combinados", "Anticoncepción de emergencia", "DIU de cobre", "DIU de levonorgestrel", "Implante subdérmico"] },
                { date: '2025-08-30', specialty: 'GINECOLOGÍA', topics: ["Progestágenos solos", "Lactancia como anticonceptivo", "Condón", "Vasectomía", "Oclusión tubaria bilateral OTB", "Infertilidad", "Cistocele e incontinencia"] },
                // ONCOGINE
                { date: '2025-08-31', specialty: 'ONCOGINE', topics: ["Tamizaje cáncer de mama", "Cáncer de mama", "Cáncer cérvicouterino", "Cáncer de endometrio", "Cáncer de ovario", "Cáncer de vagina", "Tumores anexiales"] },
                // OBSTETRICIA
                { date: '2025-09-01', specialty: 'OBSTETRICIA', topics: ["Control prenatal", "Aloinmunización materna", "Estática fetal", "Tipos de pelvis", "Atención del parto", "Manejo activo del parto"] },
                { date: '2025-09-02', specialty: 'OBSTETRICIA', topics: ["Cesárea", "Parto pretérmino", "Puerperio fisiológico", "Líquido amniótico", "Ruptura prematura de membranas", "Corioamnionitis"] },
                { date: '2025-09-03', specialty: 'OBSTETRICIA', topics: ["Distocias", "Embarazo múltiple", "Endometritis puerperal", "Hiperémesis gravídica", "Insuficiencia cervical", "Muerte fetal"] },
                { date: '2025-09-04', specialty: 'OBSTETRICIA', topics: ["Enfermedades hipertensivas del embarazo", "Preeclampsia sin datos de severidad", "Síndrome de HELLP", "Diabetes gestacional", "IVU en el embarazo", "Restricción del crecimiento intrauterino", "Sepsis puerperal"] },
                { date: '2025-09-05', specialty: 'OBSTETRICIA', topics: ["Síndrome de Sheehan", "Depresión posparto", "Generalidades de hemorragias", "Hemorragia postparto", "Desgarro perineal", "Amenaza de aborto"] },
                // HEMORRAGIAS OBSTÉTRICAS
                { date: '2025-09-06', specialty: 'HEMORRAGIAS OBSTÉTRICAS', topics: ["Aborto espontáneo", "Acretismo placentario", "Atonía uterina", "Choque hemorrágico en obstetricia", "Desprendimiento prematuro de placenta normoinserta", "Embarazo ectópico"] },
                { date: '2025-09-07', specialty: 'HEMORRAGIAS OBSTÉTRICAS', topics: ["Placenta previa", "Ruptura uterina", "Vasa previa", "Enfermedad trofoblástica gestacional", "APGAR", "Reanimación neonatal"] },
                // NEONATOLOGÍA
                { date: '2025-09-08', specialty: 'NEONATOLOGÍA', topics: ["Prematuro sano", "Recién nacido de término", "Apnea del prematuro", "Asfixia neonatal", "Síndrome de dificultad respiratoria", "Taquipnea transitoria del recién nacido"] },
                { date: '2025-09-09', specialty: 'NEONATOLOGÍA', topics: ["Síndrome de aspiración de meconio", "Displasia broncopulmonar", "Silverman Anderson", "Maduración pulmonar", "Encefalopatía hipóxica", "Enfermedad hemorrágica del recién nacido"] },
                { date: '2025-09-10', specialty: 'NEONATOLOGÍA', topics: ["Enterocolitis necrotizante", "Hipoacusia neonatal", "Hipoglucemia neonatal", "Ictericia neonatal", "Muerte súbita del lactante", "Sepsis neonatal"] },
                { date: '2025-09-11', specialty: 'NEONATOLOGÍA', topics: ["Tamiz neonatal", "Lesiones de plexo braquial obstétrico", "Lesiones extracraneales", "Displasia del desarrollo de la cadera DDC", "Cardiopatías congénitas", "Tetralogía de Fallot"] },
                // CONGÉNITAS
                { date: '2025-09-12', specialty: 'CONGÉNITAS', topics: ["Coartación aórtica", "Persistencia del conducto arterioso", "Fibrosis quística", "Fenilcetonuria", "Galactosemia clásica", "STORCH"] },
                { date: '2025-09-13', specialty: 'CONGÉNITAS', topics: ["STORCH Citomegalovirus", "STORCH Herpes simple", "STORCH Rubéola congénita", "STORCH Sífilis congénita", "STORCH Toxoplasmosis", "STORCH Varicela congénita"] },
                // ESCOLAR
                { date: '2025-09-14', specialty: 'ESCOLAR', topics: ["Control de niño sano", "Etapas del crecimiento", "Talla baja", "Alergia alimentaria", "Cuerpo extraño", "Dermatitis del pañal", "Estreñimiento funcional"] },
                { date: '2025-09-15', specialty: 'ESCOLAR', topics: ["Hiperplasia adrenal congénita", "Hipotiroidismo congénito", "Maltrato infantil", "Mucopolisacaridosis", "Reflujo gastroesofágico del lactante", "Lactancia materna"] },
                // NUTRICIÓN PEDIÁTRICA
                { date: '2025-09-16', specialty: 'NUTRICIÓN PEDIÁTRICA', topics: ["Alimentación complementaria", "Desnutrición pediátrica", "Deficiencia de vitamina A", "Hipovitaminosis", "Raquitismo carencial", "Pelagra en niños", "Intolerancia a la lactosa"] },
                { date: '2025-09-17', specialty: 'NUTRICIÓN PEDIÁTRICA', topics: ["Obesidad en escolares", "Síndrome metabólico en niños", "Adenitis mesentérica", "Onfalitis", "Exantemáticas Diferencial", "Eritema infeccioso"] },
                // INFECTOLOGÍA PEDIÁTRICA
                { date: '2025-09-18', specialty: 'INFECTOLOGÍA PEDIÁTRICA', topics: ["Escarlatina", "Exantema súbito", "Enfermedad de Kawasaki", "Síndrome mano pie boca", "Rubéola", "Sarampión", "Varicela", "Parotiditis", "Bronquiolitis", "Epiglotitis", "Laringotraqueitis CRUP", "Mononucleosis infecciosa", "Tos ferina", "IVU en menores"] },
                // VACUNAS
                { date: '2025-09-19', specialty: 'VACUNAS', topics: ["Vacunas generalidades", "Tipos de vacunas", "Vacunación universal", "Aplicación de vacunas", "Vacuna para personal de salud", "Vacunas en el embarazo", "Esquema de vacunación", "BCG", "Hepatitis A", "Hepatitis B", "Hexavalente"] },
                { date: '2025-09-20', specialty: 'VACUNAS', topics: ["Influenza", "Neumocócica", "Rotavirus", "Sabin", "Salmonella", "DPT", "SRP", "Tétanos", "Varicela", "VPH"] },
            ];
            
            let planDays = new Map();

            // Función para añadir temas a un día
            const addTopicsToDay = (dateStr, topics) => {
                if (!planDays.has(dateStr)) {
                    planDays.set(dateStr, { date: dateStr, topicsList: [] });
                }
                const dayData = planDays.get(dateStr);
                 if (!dayData.topicsList) {
                    dayData.topicsList = [];
                }
                dayData.topicsList.push(...topics);
            };

            // TYO se mantiene en su bloque
            const tyoTopics = Object.entries(allNewTopicsBySpecialty).flatMap(([specialty, topics]) => 
                topics.map(topicName => ({ 
                    topicName, 
                    subject: specialty,
                    structureType: 'object' 
                }))
            );
            const tyoStartDate = new Date('2025-07-10T00:00:00');
            const topicsPerDayTYO = Math.ceil(tyoTopics.length / 10);
            for(let i = 0; i < 10; i++) {
                const date = new Date(tyoStartDate);
                date.setDate(date.getDate() + i);
                const topicsForDay = tyoTopics.slice(i * topicsPerDayTYO, (i + 1) * topicsPerDayTYO);
                if(topicsForDay.length > 0) {
                  addTopicsToDay(date.toISOString().split('T')[0], topicsForDay);
                }
            }
            
            // Procesar los nuevos temas manualmente agendados
            const encounteredSubjects = new Set();
            manuallyScheduledDays.forEach(daySchedule => {
                const isNewSpecialty = !encounteredSubjects.has(daySchedule.specialty);
                if (isNewSpecialty) encounteredSubjects.add(daySchedule.specialty);

                const topicsForDay = daySchedule.topics.map((topic, index) => ({
                    topicName: topic,
                    subject: daySchedule.specialty,
                    isFirstOfSubject: isNewSpecialty && index === 0,
                    structureType: 'object'
                }));
                addTopicsToDay(daySchedule.date, topicsForDay);
            });
            
            const scheduledDaysPart2 = Array.from(planDays.values());
            
            // Combinar todo
            let finalPlannedDays = [ ...plannedDaysPart1.reverse(), endoDay, ...oftalmoDays, ...orlDays, ...scheduledDaysPart2 ];
            
            const finalMap = new Map();
            finalPlannedDays.forEach(day => { finalMap.set(day.date, {...finalMap.get(day.date), ...day}); });
            let lastPlannedDate = new Date(Array.from(finalMap.keys()).reduce((max, date) => date > max ? date : max, '2000-01-01'));
            let finalCalendarDate = new Date('2025-09-30');
            while(lastPlannedDate < finalCalendarDate) {
                lastPlannedDate.setDate(lastPlannedDate.getDate() + 1);
                const dateString = lastPlannedDate.toISOString().split('T')[0];
                if (!finalMap.has(dateString)) finalMap.set(dateString, { date: dateString, blocks: [], topicsList: [] });
            }

            const finalPlan = Array.from(finalMap.values()).sort((a,b) => new Date(a.date) - new Date(b.date));
            recalculateFirstOfSubjectFlags(finalPlan);
            return finalPlan;
        }

        function getData(key, defaultValue = null) { const keys = key.split('.'); let result = userProgress; for (const k of keys) { if (result && typeof result === 'object' && k in result) { result = result[k]; } else { return defaultValue; } } return result; }
        function isTopicComplete(topicId) { return ALL_TASK_IDS.every(taskId => getData(`topicData.${topicId}.${taskId}`) === true); }
        function isSubjectComplete(subjectName) { const topicIds = subjectToTopicsMap.get(subjectName); if (!topicIds || topicIds.length === 0) return false; return topicIds.every(topicId => isTopicComplete(topicId)); }
        function getTopicKanbanState(topicId) { const progress = getTopicProgress(topicId); if (progress.completionPercentage === 100) return 'done'; if (progress.completionPercentage > 0) return 'inprogress'; return 'todo'; }
        function getTopicProgress(topicId) { const checkedCount = ALL_TASK_IDS.filter(taskId => getData(`topicData.${topicId}.${taskId}`) === true).length; const completionPercentage = (checkedCount / ALL_TASK_IDS.length) * 100; const reactivos = parseInt(getData(`topicData.${topicId}.scoreReactivos`, '0')) || 0; const aciertos = parseInt(getData(`topicData.${topicId}.scoreAciertos`, '0')) || 0; const scorePercentage = reactivos > 0 ? (aciertos / reactivos) * 100 : 0; return { completionPercentage, scorePercentage }; }
        function displayDailyQuote() { if (quoteContainer) { const randomIndex = Math.floor(Math.random() * motivationalQuotes.length); quoteContainer.textContent = motivationalQuotes[randomIndex]; } }
        function startCountdown() { if (countdownInterval) clearInterval(countdownInterval); if (!countdownTargetDateStr) return; const targetDate = new Date(`${countdownTargetDateStr}T08:00:00`).getTime(); const daysEl = document.getElementById('countdown-days'); const hoursEl = document.getElementById('countdown-hours'); const minutesEl = document.getElementById('countdown-minutes'); const secondsEl = document.getElementById('countdown-seconds'); const update = () => { const now = new Date().getTime(); const distance = targetDate - now; if (distance < 0) { daysEl.textContent = "000"; hoursEl.textContent = "00"; minutesEl.textContent = "00"; secondsEl.textContent = "00"; clearInterval(countdownInterval); return; } daysEl.textContent = String(Math.floor(distance / (1000 * 60 * 60 * 24))).padStart(3, '0'); hoursEl.textContent = String(Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60))).padStart(2, '0'); minutesEl.textContent = String(Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60))).padStart(2, '0'); secondsEl.textContent = String(Math.floor((distance % (1000 * 60)) / 1000)).padStart(2, '0'); }; update(); countdownInterval = setInterval(update, 1000); }
        
        function createTopicListItem(topic, subject = null) {
            const isObject = typeof topic === 'object' && topic !== null;
            const topicName = isObject ? topic.topicName : topic;
            const topicId = generateTopicId(topicName);
            const isComplete = isTopicComplete(topicId);
            const isRentable = rentableTopics.has(topicName);
            const liClass = `topic-item ${isComplete ? 'topic-completed' : ''} ${isRentable ? 'topic-rentable' : ''}`;
            let scoreHTML = '';
            const { scorePercentage } = getTopicProgress(topicId);
            const reactivos = parseInt(getData(`topicData.${topicId}.scoreReactivos`, '0')) || 0;
            if (reactivos > 0) {
                const color = getScoreColor(scorePercentage);
                scoreHTML = `<span class="topic-score" style="color: ${color};">(${scorePercentage.toFixed(1)}%)</span>`;
            }
            
            const subjectAttr = subject || (isObject ? topic.subject : getSubjectForTopic(topicName));
            const structureType = isObject ? topic.structureType : 'string';

            return `<li class="${liClass}" draggable="true" data-topic-id="${topicId}" data-topic-name="${topicName}" data-subject="${subjectAttr}" data-structure-type="${structureType}"><span>${topicName}</span>${scoreHTML}</li>`;
        }

        function buildSubjectMap() {
            subjectToTopicsMap.clear();
            if (!studyPlan) return;
            studyPlan.forEach(day => {
                if (day.blocks) {
                    day.blocks.forEach(block => {
                        if (block.subject) {
                            if (!subjectToTopicsMap.has(block.subject)) subjectToTopicsMap.set(block.subject, []);
                            const topicsForSubject = subjectToTopicsMap.get(block.subject);
                            (block.topics || []).map(generateTopicId).forEach(id => {
                                if (!topicsForSubject.includes(id)) topicsForSubject.push(id);
                            });
                        }
                    });
                }
                if (day.topicsList) {
                    day.topicsList.forEach(topicObj => {
                        if (topicObj.subject) {
                            if (!subjectToTopicsMap.has(topicObj.subject)) subjectToTopicsMap.set(topicObj.subject, []);
                            const topicsForSubject = subjectToTopicsMap.get(topicObj.subject);
                            const topicId = generateTopicId(topicObj.topicName);
                            if (!topicsForSubject.includes(topicId)) topicsForSubject.push(topicId);
                        }
                    });
                }
            });
        }

        function calculateSubjectScore(subjectName) { const topicIds = subjectToTopicsMap.get(subjectName); if (!topicIds || topicIds.length === 0) return null; let totalScoreSum = 0; let scoredTopicsCount = 0; topicIds.forEach(topicId => { const reactivos = parseInt(getData(`topicData.${topicId}.scoreReactivos`)) || 0; if (reactivos > 0) { const { scorePercentage } = getTopicProgress(topicId); totalScoreSum += scorePercentage; scoredTopicsCount++; } }); return scoredTopicsCount > 0 ? (totalScoreSum / scoredTopicsCount).toFixed(2) : null; }
        function updateGlobalProgressBars() { if (!studyPlan) return; buildSubjectMap(); let totalTopics = 0; subjectToTopicsMap.forEach((topics) => { totalTopics += topics.length; }); let completedTopics = 0; subjectToTopicsMap.forEach((topicIds) => { topicIds.forEach(topicId => { if (isTopicComplete(topicId)) { completedTopics++; } }); }); const advancePercentage = totalTopics > 0 ? (completedTopics / totalTopics) * 100 : 0; globalAdvanceBar.style.width = `${advancePercentage}%`; globalAdvanceBar.textContent = `${advancePercentage.toFixed(1)}%`; let totalSubjectScoreSum = 0; let subjectsWithScoresCount = 0; subjectToTopicsMap.forEach((_, subject) => { const subjectScoreStr = calculateSubjectScore(subject); if (subjectScoreStr !== null) { totalSubjectScoreSum += parseFloat(subjectScoreStr); subjectsWithScoresCount++; }}); const scorePercentage = subjectsWithScoresCount > 0 ? totalSubjectScoreSum / subjectsWithScoresCount : 0; globalScoreBar.style.width = `${scorePercentage}%`; globalScoreBar.textContent = `${scorePercentage.toFixed(1)}%`; }
        
        function populateCalendar() {
            if (!studyPlan) return;
            buildSubjectMap();
            const daysMap = new Map(studyPlan.map(day => [day.date, day]));
            const startDate = new Date(studyPlan[0].date + "T00:00:00");
            const finalDate = new Date(studyPlan[studyPlan.length - 1].date + "T00:00:00");
            let dayBeforeTargetStr = '2025-09-22';
            
            let weeks = [];
            let dateCursor = new Date(startDate);
            dateCursor.setDate(dateCursor.getDate() - dateCursor.getDay());
            while (dateCursor <= finalDate) {
                let week = [];
                for(let i=0; i < 7; i++) { week.push(new Date(dateCursor)); dateCursor.setDate(dateCursor.getDate() + 1); }
                weeks.push(week);
            }
            const monthLayout = new Map();
            weeks.forEach((week, weekIndex) => { const firstDayOfWeek = week[0]; const monthName = firstDayOfWeek.toLocaleString('es-ES', { month: 'long' }); if (!monthLayout.has(monthName)) { monthLayout.set(monthName, { startRow: weekIndex + 2, rowSpan: 1 }); } else { monthLayout.get(monthName).rowSpan++; } });
            calendarContainer.innerHTML = '';
            calendarContainer.innerHTML += '<div class="header-cell meta-header">M</div><div class="header-cell meta-header">S</div>';
            ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'].forEach(day => calendarContainer.innerHTML += `<div class="header-cell day-header">${day}</div>`);
            monthLayout.forEach((layout, name) => { calendarContainer.innerHTML += `<div class="month-cell" style="grid-row: ${layout.startRow} / span ${layout.rowSpan}">${name}</div>`; });
            
            const globallyDisplayedSubjects = new Set();

            weeks.forEach((week, weekIndex) => {
                calendarContainer.innerHTML += `<div class="week-cell-container" style="grid-row: ${weekIndex + 2}"><span class="week-number">${weekIndex + 1}</span></div>`;
                week.forEach(date => {
                    const cell = document.createElement('div');
                    cell.className = 'day-cell';
                    const dateString = date.toISOString().split('T')[0];
                     if (date < startDate || date > finalDate) {
                        cell.classList.add('empty');
                    } else {
                        cell.dataset.date = dateString;
                        cell.innerHTML = `<div class="calendar-day-number">${date.getDate()}</div>`;
                        const dayData = daysMap.get(dateString);
                        let contentHTML = '<ul>';

                        if (dayData && dayData.blocks) {
                            dayData.blocks.forEach(block => {
                                if (block.subject && !globallyDisplayedSubjects.has(block.subject)) {
                                    const score = calculateSubjectScore(block.subject);
                                    const scoreText = score !== null ? `<span class="subject-score">(${score}%)</span>` : '';
                                    contentHTML += `<li><span class="subject-title">${block.subject}${scoreText}</span></li>`;
                                    globallyDisplayedSubjects.add(block.subject);
                                }
                                if (block.topics) contentHTML += block.topics.map(topic => createTopicListItem(topic, block.subject)).join('');
                            });
                        }
                        
                        if (dayData && dayData.topicsList) {
                            dayData.topicsList.forEach(topicObj => {
                                if (topicObj.isFirstOfSubject) {
                                    const score = calculateSubjectScore(topicObj.subject);
                                    const scoreText = score !== null ? `<span class="subject-score">(${score}%)</span>` : '';
                                    contentHTML += `<li><span class="subject-title">${topicObj.subject}${scoreText}</span></li>`;
                                }
                                contentHTML += createTopicListItem(topicObj);
                            });
                        }

                        contentHTML += '</ul>';
                        if (contentHTML !== '<ul></ul>') cell.innerHTML += `<div class="day-content">${contentHTML}</div>`;
                        if (dateString === countdownTargetDateStr) cell.classList.add('target-date');
                        if (dateString === dayBeforeTargetStr) cell.classList.add('day-before-target');
                    }
                    calendarContainer.appendChild(cell);
                });
            });
            updateGlobalProgressBars();
        }

        function createSpecialtyHeaderHTML(specialtyName, colorVar) { const specialtyId = generateTopicId(specialtyName); return `<div class="specialty-header" data-specialty-header="${specialtyName}" style="border-left-color: ${colorVar}"><div class="specialty-header-main"><h3 style="color: ${colorVar}">${specialtyName}</h3></div><div class="specialty-progress-wrapper"><small>Avance</small><div class="specialty-progress-container"><div class="specialty-progress-bar" id="sp-progress-${specialtyId}"></div></div><span class="specialty-percentage-text" id="sp-progress-text-${specialtyId}">0%</span></div><div class="specialty-progress-wrapper"><small>Nota</small><div class="specialty-progress-container"><div class="specialty-score-bar" id="sp-score-${specialtyId}"></div></div><span class="specialty-percentage-text" id="sp-score-text-${specialtyId}">0%</span></div></div>`; }
        function populateKanbanBoard() { todoContainer.innerHTML = ''; inprogressContainer.innerHTML = ''; doneContainer.innerHTML = ''; const specialtyColors = ['var(--step-1-color)', 'var(--step-2-color)', 'var(--step-3-color)', 'var(--step-4-color)', 'var(--step-5-color)', 'var(--step-6-color)', '#E6B0AA', '#D7BDE2', '#A9CCE3', '#A3E4D7', '#FAD7A0', '#F5CBA7', '#C8E6C9', '#BBDEFB', '#FFECB3', '#D1C4E9']; let colorIndex = 0; const allSpecialties = {}; buildSubjectMap(); subjectToTopicsMap.forEach((topicIds, specialtyName) => { const topicNames = topicIds.map(id => { for (const day of studyPlan) { for (const block of day.blocks || []) { if (block.topics) { const foundTopic = block.topics.find(t => generateTopicId(t) === id); if (foundTopic) return foundTopic; } } for (const topicObj of day.topicsList || []) { if (generateTopicId(topicObj.topicName) === id) return topicObj.topicName; } } return null; }).filter(Boolean); if (topicNames.length > 0) { allSpecialties[specialtyName] = { topics: topicNames, color: specialtyColors[colorIndex % specialtyColors.length] }; colorIndex++; } }); for (const specialtyName in allSpecialties) { const specialtyData = allSpecialties[specialtyName]; const headerHTML = createSpecialtyHeaderHTML(specialtyName, specialtyData.color); const specialtyFragments = { todo: document.createDocumentFragment(), inprogress: document.createDocumentFragment(), done: document.createDocumentFragment() }; specialtyData.topics.forEach(topicName => { const topicId = generateTopicId(topicName); const state = getTopicKanbanState(topicId); const cardHTML = createKanbanCardHTML(topicName, topicId, specialtyName); const cardElement = document.createElement('div'); cardElement.innerHTML = cardHTML; specialtyFragments[state].appendChild(cardElement.firstChild); }); if (specialtyFragments.todo.hasChildNodes()) { todoContainer.innerHTML += headerHTML; todoContainer.appendChild(specialtyFragments.todo); } if (specialtyFragments.inprogress.hasChildNodes()) { inprogressContainer.innerHTML += headerHTML; inprogressContainer.appendChild(specialtyFragments.inprogress); } if (specialtyFragments.done.hasChildNodes()) { doneContainer.innerHTML += headerHTML; doneContainer.appendChild(specialtyFragments.done); } } updateAllSpecialtyProgressOnBoard(); }
        function createKanbanCardHTML(topicName, topicId, specialtyName) { const { completionPercentage, scorePercentage } = getTopicProgress(topicId); const scoreColor = getScoreColor(scorePercentage); const state = getTopicKanbanState(topicId); const isRentable = rentableTopics.has(topicName); let statusColorVar = '--color-todo'; if (state === 'inprogress') statusColorVar = '--color-inprogress'; if (state === 'done') statusColorVar = '--color-done'; return `<article class="kanban-card ${isRentable ? 'topic-rentable' : ''}" data-topic-id="${topicId}" data-topic-name="${topicName}" data-specialty="${specialtyName}" style="border-left: 4px solid var(${statusColorVar});"><div class="card-summary"><div class="card-topic-name">${topicName}</div><div class="card-progress-display"><div class="card-progress-bar-container"><div class="card-progress-bar" style="width: ${completionPercentage}%; background-color: var(${statusColorVar});"></div></div><span class="card-progress-text">${completionPercentage.toFixed(0)}%</span><span class="card-score-text" style="color: ${scoreColor}">${scorePercentage.toFixed(0)}%</span></div></div></article>`; }
        function showDayModal(dateString) { const dayData = studyPlan.find(d => d.date === dateString); if (!dayData) return; const date = new Date(dateString + "T00:00:00"); dayModalTitle.textContent = date.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }); let topicsHTML = '<ul>'; if (dayData && dayData.blocks) { let modalSubjects = new Set(); dayData.blocks.forEach(block => { if (block.subject && !modalSubjects.has(block.subject)) { const score = calculateSubjectScore(block.subject); const scoreText = score !== null ? `<span class="subject-score">(${score}%)</span>` : ''; topicsHTML += `<li><span class="subject-title">${block.subject}${scoreText}</span></li>`; modalSubjects.add(block.subject); } if(block.topics) { topicsHTML += block.topics.map(topic => createTopicListItem(topic, block.subject)).join(''); } }); } if (dayData && dayData.topicsList) { dayData.topicsList.forEach(topicObj => { if (topicObj.isFirstOfSubject) { const score = calculateSubjectScore(topicObj.subject); const scoreText = score !== null ? `<span class="subject-score">(${score}%)</span>` : ''; topicsHTML += `<li><span class="subject-title">${topicObj.subject}${scoreText}</span></li>`; } topicsHTML += createTopicListItem(topicObj); }); } topicsHTML += '</ul>'; dayModalTopicsContainer.innerHTML = topicsHTML; dayModalNotes.value = getData(`dayNotes.${dateString}`, ''); dayModal.dataset.currentDate = dateString; dayModalOverlay.classList.add('visible'); dayModal.classList.add('visible'); }
        function closeDayModal() { dayModalOverlay.classList.remove('visible'); dayModal.classList.remove('visible'); }
        function saveDayNote() { const dateString = dayModal.dataset.currentDate; if (dateString) { saveData(`dayNotes.${dateString}`, dayModalNotes.value); } closeDayModal(); }
        function showTopicPlan(topicId, topicName) { topicModal.dataset.currentTopicId = topicId; topicModalTitle.textContent = topicName; loadTopicState(topicId); topicModalOverlay.classList.add('visible'); topicModal.classList.add('visible'); }
        function closeTopicModal() { const topicId = topicModal.dataset.currentTopicId; topicModalOverlay.classList.remove('visible'); topicModal.classList.remove('visible'); if (topicId) { updateUIForTopic(topicId); } }
        function loadTopicState(topicId) { topicTaskCheckboxes.forEach(checkbox => { checkbox.checked = getData(`topicData.${topicId}.${checkbox.id}`) === true; }); aciertosInput.value = getData(`topicData.${topicId}.scoreAciertos`, ''); reactivosInput.value = getData(`topicData.${topicId}.scoreReactivos`, ''); updateScorePercentage(); updateAllStepCardsStatus(); }
        function saveTopicState(key, value) { const topicId = topicModal.dataset.currentTopicId; if (topicId) { saveData(`topicData.${topicId}.${key}`, value); } }
        function updateScorePercentage() { const aciertos = parseInt(aciertosInput.value) || 0; const reactivos = parseInt(reactivosInput.value) || 0; let percentage = 0; if (reactivos > 0) { percentage = (aciertos / reactivos) * 100; } const color = getScoreColor(percentage); percentageOutput.value = percentage.toFixed(2) + "%"; percentageOutput.style.color = color; }
        function updateStepCardStatus(cardElement) { const tasksInCard = cardElement.querySelectorAll('.task-checkbox'); const allTasksCompleted = Array.from(tasksInCard).every(task => task.checked); cardElement.classList.toggle('completed', allTasksCompleted); }
        function updateAllStepCardsStatus() { topicStepCards.forEach(updateStepCardStatus); }
        function finishTopicSession() { closeTopicModal(); }
        function updateUIForTopic(topicId) { const isBoardVisible = !boardView.classList.contains('hidden'); if (isBoardVisible) { populateKanbanBoard(); } else { populateCalendar(); } updateGlobalProgressBars(); }
        function updateAllSpecialtyProgressOnBoard() { const headers = document.querySelectorAll('.specialty-header'); headers.forEach(header => { const specialtyName = header.dataset.specialtyHeader; const specialtyId = generateTopicId(specialtyName); const topicIds = subjectToTopicsMap.get(specialtyName) || []; const progressTextEl = document.getElementById(`sp-progress-text-${specialtyId}`); const scoreTextEl = document.getElementById(`sp-score-text-${specialtyId}`); const progressBar = document.getElementById(`sp-progress-${specialtyId}`); const scoreBar = document.getElementById(`sp-score-${specialtyId}`); if (!progressTextEl || !scoreTextEl || !progressBar || !scoreBar) return; let totalCompletion = 0, totalScore = 0, scoredTopics = 0; topicIds.forEach(topicId => { const { completionPercentage, scorePercentage } = getTopicProgress(topicId); totalCompletion += completionPercentage; const reactivos = parseInt(getData(`topicData.${topicId}.scoreReactivos`)) || 0; if (reactivos > 0 || isTopicComplete(topicId)) { totalScore += scorePercentage; scoredTopics++; } }); const avgCompletion = topicIds.length > 0 ? totalCompletion / topicIds.length : 0; const avgScore = scoredTopics > 0 ? totalScore / scoredTopics : 0; progressBar.style.width = `${avgCompletion}%`; progressTextEl.textContent = `${avgCompletion.toFixed(0)}%`; scoreBar.style.width = `${avgScore}%`; scoreTextEl.textContent = `${avgScore.toFixed(0)}%`; scoreBar.classList.remove('low', 'medium', 'high'); if (scoredTopics > 0 || avgCompletion === 100) { const colorClass = getScoreColor(avgScore); if(colorClass.includes('error')) scoreBar.classList.add('low'); if(colorClass.includes('warning')) scoreBar.classList.add('medium'); if(colorClass.includes('green')) scoreBar.classList.add('high'); } }); }
        function getSubjectForTopic(topicName) { for (const day of studyPlan) { if (day.blocks) { for (const block of day.blocks) { if (block.topics && block.topics.includes(topicName)) return block.subject; } } if (day.topicsList) { for (const topicObj of day.topicsList) { if (topicObj.topicName === topicName) return topicObj.subject; } } } return null; }
        let draggedItem = null; let lastDragOverCell = null; let lastDragOverTopic = null; function clearDragStyles() { if (lastDragOverCell) lastDragOverCell.classList.remove('drag-over'); if (lastDragOverTopic) lastDragOverTopic.classList.remove('drag-over-top', 'drag-over-bottom'); lastDragOverCell = null; lastDragOverTopic = null; }
        
        function main() {
            assignDOMelements();
            displayDailyQuote();
            const authBtn = document.getElementById('auth-btn');
            const userDisplay = document.getElementById('user-display');
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    userDisplay.textContent = `Hola, ${user.displayName.split(' ')[0]}`;
                    userDisplay.style.display = 'inline';
                    authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
                    authBtn.style.backgroundColor = 'var(--error-color)';
                    loadProgressFromFirestore(); 
                } else {
                    currentUser = null;
                    userDisplay.style.display = 'none';
                    authBtn.innerHTML = '<i class="fab fa-google" style="margin-right: 8px;"></i> Login';
                    authBtn.style.backgroundColor = '#4A90E2';
                    calendarContainer.innerHTML = '<div style="grid-column: 1 / -1; text-align:center; padding: 40px; font-size: 1.2em;">Inicia sesión con Google para ver y guardar tu progreso.</div>';
                }
            });
            authBtn.addEventListener('click', () => {
                if (currentUser) {
                    auth.signOut();
                } else {
                    const provider = new firebase.auth.GoogleAuthProvider();
                    auth.signInWithPopup(provider).catch(error => { console.error("Error durante el login:", error); alert("Hubo un error al iniciar sesión: " + error.message); });
                }
            });

            viewSwitcher.addEventListener('click', switchView);
            boardView.addEventListener('click', e => { const card = e.target.closest('.kanban-card'); if (card) { const { topicId, topicName } = card.dataset; showTopicPlan(topicId, topicName); }});
            calendarContainer.addEventListener('click', e => { const topicLi = e.target.closest('.topic-item'); if (topicLi && !draggedItem) { const { topicId, topicName } = topicLi.dataset; showTopicPlan(topicId, topicName); return; } const cell = e.target.closest('.day-cell:not(.empty)'); if (cell) showDayModal(cell.dataset.date); });
            dayModalTopicsContainer.addEventListener('click', e => { const topicLi = e.target.closest('.topic-item'); if (topicLi) { const { topicId, topicName } = topicLi.dataset; showTopicPlan(topicId, topicName); } });
            editCountdownBtn.addEventListener('click', () => { countdownEditor.style.display = countdownEditor.style.display === 'flex' ? 'none' : 'flex'; });
            saveCountdownBtn.addEventListener('click', () => { const newDate = countdownDatePicker.value; if (newDate) { countdownTargetDateStr = newDate; saveData('countdownTarget', newDate); startCountdown(); populateCalendar(); countdownEditor.style.display = 'none'; } });
            dayModal.querySelector('#modal-close-day').addEventListener('click', closeDayModal);
            dayModalOverlay.addEventListener('click', closeDayModal);
            topicModal.querySelector('#modal-close-topic').addEventListener('click', closeTopicModal);
            finishTopicButton.addEventListener('click', finishTopicSession);
            document.addEventListener('keydown', e => { if (e.key === 'Escape') { if (topicModal.classList.contains('visible')) closeTopicModal(); else if (dayModal.classList.contains('visible')) closeDayModal(); } });
            saveNoteButton.addEventListener('click', saveDayNote);
            topicTaskCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', function() { const topicId = topicModal.dataset.currentTopicId; saveTopicState(this.id, this.checked); updateStepCardStatus(this.closest('.step-card')); updateUIForTopic(topicId); }); });
            aciertosInput.addEventListener('input', () => { const topicId = topicModal.dataset.currentTopicId; saveTopicState('scoreAciertos', aciertosInput.value); updateScorePercentage(); updateUIForTopic(topicId); });
            reactivosInput.addEventListener('input', () => { const topicId = topicModal.dataset.currentTopicId; saveTopicState('scoreReactivos', reactivosInput.value); updateScorePercentage(); updateUIForTopic(topicId); });
            calendarContainer.addEventListener('dragstart', e => { if (e.target.classList.contains('topic-item')) { draggedItem = e.target; const { topicName, subject, structureType } = draggedItem.dataset; e.dataTransfer.setData('application/json', JSON.stringify({ topicName, subject, structureType })); setTimeout(() => e.target.classList.add('dragging'), 0); } });
            calendarContainer.addEventListener('dragend', e => { if (draggedItem) { draggedItem.classList.remove('dragging'); draggedItem = null; clearDragStyles(); } });
            calendarContainer.addEventListener('dragover', e => { e.preventDefault(); const targetCell = e.target.closest('.day-cell:not(.empty)'); if (!targetCell || !draggedItem) { clearDragStyles(); return; } const sourceDate = draggedItem.closest('.day-cell').dataset.date; const targetDate = targetCell.dataset.date; clearDragStyles(); if (sourceDate === targetDate) { const targetTopic = e.target.closest('.topic-item'); if (targetTopic && targetTopic !== draggedItem) { lastDragOverTopic = targetTopic; const rect = targetTopic.getBoundingClientRect(); const midpointY = rect.top + rect.height / 2; if (e.clientY < midpointY) { targetTopic.classList.add('drag-over-top'); } else { targetTopic.classList.add('drag-over-bottom'); } } } else { lastDragOverCell = targetCell; targetCell.classList.add('drag-over'); } });
            calendarContainer.addEventListener('drop', e => {
                e.preventDefault(); if (!draggedItem) return;
                const targetCell = e.target.closest('.day-cell');
                if (!targetCell || targetCell.classList.contains('empty')) { clearDragStyles(); return; }
                const sourceDate = draggedItem.closest('.day-cell').dataset.date;
                const targetDate = targetCell.dataset.date;
                const { topicName, subject, structureType } = JSON.parse(e.dataTransfer.getData('application/json'));
                const sourceDay = studyPlan.find(d => d.date === sourceDate);
                let targetDay = studyPlan.find(d => d.date === targetDate);
                if (!sourceDay || !targetDay) return;

                let movedItem = null;
                let removed = false;

                if (structureType === 'object') {
                    if (sourceDay.topicsList) {
                        const itemIndex = sourceDay.topicsList.findIndex(item => item.topicName === topicName);
                        if (itemIndex > -1) {
                            movedItem = sourceDay.topicsList.splice(itemIndex, 1)[0];
                            removed = true;
                        }
                    }
                } else { 
                    if (sourceDay.blocks) {
                        sourceDay.blocks.forEach(block => {
                            if (block.subject === subject && block.topics) {
                                const topicIndex = block.topics.indexOf(topicName);
                                if (topicIndex > -1) {
                                    block.topics.splice(topicIndex, 1);
                                    movedItem = topicName;
                                    removed = true;
                                }
                            }
                        });
                    }
                }
                if (!removed) { clearDragStyles(); return; }

                const targetTopicEl = e.target.closest('.topic-item');
                if (structureType === 'object') {
                    if (!targetDay.topicsList) targetDay.topicsList = [];
                    if (targetTopicEl && sourceDate === targetDate) {
                        const targetTopicName = targetTopicEl.dataset.topicName;
                        const targetIndex = targetDay.topicsList.findIndex(t => t.topicName === targetTopicName);
                        const rect = targetTopicEl.getBoundingClientRect();
                        const insertBefore = e.clientY < (rect.top + rect.height / 2);
                        targetDay.topicsList.splice(insertBefore ? targetIndex : targetIndex + 1, 0, movedItem);
                    } else {
                        targetDay.topicsList.push(movedItem);
                    }
                    recalculateFirstOfSubjectFlags(studyPlan);
                } else { 
                    let targetBlock = targetDay.blocks ? targetDay.blocks.find(b => b.subject === subject) : null;
                    if (!targetBlock) {
                        if (!targetDay.blocks) targetDay.blocks = [];
                        targetBlock = { subject: subject, topics: [] };
                        targetDay.blocks.push(targetBlock);
                    }
                    targetBlock.topics.push(movedItem);
                }
                
                studyPlan.forEach(day => {
                    if (day.blocks) day.blocks = day.blocks.filter(block => block.topics && block.topics.length > 0);
                });

                clearDragStyles();
                saveData('studyPlan', studyPlan);
                populateCalendar();
            });
        }
        main();
    });
    </script>
</body>
</html>
