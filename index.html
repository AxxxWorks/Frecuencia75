<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Frecuencia Vital - Plan de Estudio Definitivo 2025</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=Source+Sans+Pro:wght@300;400;600;700&display=swap');
        :root{--bg-color:#121212;--cell-bg:#1a1a1a;--main-border:#2c2c2c;--text-color:#e0e0e0;--text-secondary:#a0a0a0;--accent-color:#00ff7f;--meta-bg:#181c25;--meta-header-bg:#101217;--meta-border:#2c3240;--meta-text:#a9bce2;--plan-bg:#1e1e1e;--vfd-green:#50e050;--progress-score-bg:#4caf50;--progress-advance-bg:#ff9800;--text-completed:#777;--bullet-completed:#555;--tag-text-dark:#111;--error-color:#ff6b6b;--warning-color:#ff9800;--shadow-color:rgba(0,0,0,.4);--step-1-color:#03dac6;--step-2-color:#ffb74d;--step-3-color:#4fc3f7;--step-4-color:#ce93d8;--step-5-color:#ef9a9a;--step-6-color:#a5d6a7;--color-todo:var(--text-secondary);--color-inprogress:var(--step-3-color);--color-done:var(--vfd-green)}*{box-sizing:border-box;margin:0;padding:0}body{font-family:'Source Sans Pro',sans-serif;background-color:var(--bg-color);color:var(--text-color);margin:0;overflow:hidden;height:100vh;display:flex;flex-direction:column}.app-banner{padding:20px 25px;background-color:var(--bg-color);border-bottom:1px solid var(--main-border);flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:20px}.banner-bottom-row{display:flex;width:100%;align-items:center;gap:20px}.global-progress-container{flex-grow:1;display:flex;flex-direction:column;gap:10px}.main-content-area{flex-grow:1;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--main-border) var(--bg-color)}.view-wrapper{padding:20px}.view-wrapper.hidden{display:none}.view-switcher{background-color:var(--accent-color);color:var(--bg-color);border:none;padding:10px 20px;border-radius:6px;font-family:'Orbitron',sans-serif;font-weight:700;cursor:pointer;transition:all .2s ease;flex-shrink:0}.view-switcher:hover{background-color:#39ff94;transform:translateY(-2px)}.motivational-quote{font-family:'Orbitron',sans-serif;color:var(--vfd-green);font-size:1.5em;text-transform:uppercase;letter-spacing:2px;text-shadow:0 0 4px rgba(80,224,80,.6),0 0 8px rgba(80,224,80,.4);min-height:1.2em}.countdown-container{position:relative;display:inline-block}.countdown-timer-container{display:flex;justify-content:center;align-items:center;gap:25px}.countdown-unit{text-align:center}.countdown-label{font-family:'Orbitron',sans-serif;font-size:.8em;color:var(--vfd-green);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;opacity:.8}.countdown-digits{font-family:'Orbitron',sans-serif;font-size:4em;color:var(--vfd-green);line-height:1;text-shadow:0 0 5px rgba(80,224,80,.7),0 0 10px rgba(80,224,80,.5),0 0 15px rgba(80,224,80,.3)}#edit-countdown-btn{position:absolute;top:-5px;right:-30px;background:0 0;border:none;color:var(--meta-text);font-size:1.2em;cursor:pointer;transition:color .2s}#edit-countdown-btn:hover{color:var(--accent-color)}#countdown-editor{display:none;margin-top:10px;align-items:center;justify-content:center;gap:10px}#countdown-date-picker{background-color:var(--cell-bg);border:1px solid var(--main-border);color:var(--text-color);padding:5px;border-radius:4px;font-family:'Source Sans Pro',sans-serif}#countdown-date-picker::-webkit-calendar-picker-indicator{filter:invert(1);cursor:pointer}#save-countdown-btn{background-color:var(--accent-color);color:var(--bg-color);border:none;padding:6px 12px;border-radius:4px;font-weight:700;cursor:pointer}.progress-bar-wrapper{display:flex;flex-direction:column;gap:4px}.progress-bar-wrapper label{font-size:.85em;color:var(--meta-text);font-weight:600;text-align:left}.progress-bar-background{width:100%;background-color:var(--main-border);border-radius:8px;height:22px;overflow:hidden}.progress-bar-fill{height:100%;width:0;border-radius:8px;transition:width .5s ease-in-out;text-align:center;line-height:22px;color:var(--bg-color);font-weight:700;font-size:.8em}#global-score-bar{background-color:var(--progress-score-bg)}#global-advance-bar{background-color:var(--progress-advance-bg)}#auth-container{display:flex;align-items:center;gap:15px;flex-shrink:0}#user-display{font-weight:600;display:none;color:var(--text-color)}#auth-btn{background-color:#4a90e2}#auth-btn i{margin-right:8px}.calendar-container{display:grid;grid-template-columns:40px 40px repeat(7,1fr);gap:2px;background-color:var(--main-border)}.header-cell,.day-header{text-align:center;padding:12px 5px;font-weight:600;font-family:'Orbitron',sans-serif;text-transform:uppercase;font-size:.9em}.meta-header{background-color:var(--meta-header-bg);color:var(--meta-text);border-bottom:2px solid var(--main-border)}.day-header{background-color:var(--cell-bg);color:var(--accent-color);border-bottom:2px solid var(--main-border)}.month-cell{grid-column:1;background-color:var(--meta-bg);color:var(--meta-text);font-family:'Orbitron',sans-serif;writing-mode:vertical-rl;text-transform:uppercase;letter-spacing:2px;display:flex;align-items:center;justify-content:center;border-right:1px solid var(--meta-border)}.week-cell-container{grid-column:2;background-color:var(--meta-bg);position:relative;display:flex;align-items:center;justify-content:center;border-bottom:1px solid var(--meta-border)}.week-number{font-family:'Orbitron',sans-serif;font-size:1.6em;color:var(--meta-text)}.day-cell{background-color:var(--cell-bg);min-height:160px;padding:8px 12px;position:relative;overflow-y:auto;cursor:pointer;transition:all .2s;border:2px solid transparent}.day-cell.empty{background-color:var(--bg-color);cursor:default}.day-cell.drag-over{background-color:var(--meta-bg);border-color:var(--accent-color)}.day-cell.target-date{border-color:var(--error-color);box-shadow:0 0 10px rgba(255,107,107,.4)}.day-cell.target-date .calendar-day-number{color:var(--error-color);font-weight:700}.day-cell.day-before-target{border-color:var(--warning-color)}.day-cell.day-before-target .calendar-day-number{color:var(--warning-color)}.calendar-day-number{font-size:.9em;font-weight:600;color:#777;position:absolute;top:8px;right:12px;z-index:1;transition:color .2s}.day-content ul{list-style-type:none;padding-left:0;margin:25px 0 0}.day-content li{margin-bottom:4px;padding-left:14px;position:relative;font-size:.85em}.day-content .subject-title{color:var(--text-color);font-weight:700;display:block;margin-bottom:6px;text-transform:uppercase;font-size:1em;text-shadow:0 0 4px rgba(255,255,255,.15);padding-left:0;transition:color .4s ease}.day-content .subject-title.subject-completed{color:var(--text-completed);text-shadow:none;font-style:italic}.subject-title::before{content:none!important}.subject-score{color:var(--meta-text);font-size:.8em;font-weight:400;margin-left:8px}.topic-item{display:flex;align-items:center;justify-content:space-between;padding:4px 6px;margin-left:-6px;border-radius:4px;transition:all .2s;border-top:2px solid transparent;border-bottom:2px solid transparent}.topic-item[draggable=true]{cursor:grab}.topic-item.dragging{opacity:.5}.topic-item:not(.topic-completed):not(.dragging):hover{background-color:var(--meta-bg);color:var(--accent-color)}.topic-item.drag-over-top{border-top-color:var(--accent-color)}.topic-item.drag-over-bottom{border-bottom-color:var(--accent-color)}.topic-item::before{content:'■';position:absolute;left:0;top:5px;color:var(--accent-color);font-size:.8em;line-height:1.5;transition:color .3s ease}.topic-score{font-size:.85em;font-weight:700;margin-left:10px;flex-shrink:0}.topic-item.topic-completed{color:var(--text-completed);font-style:italic}.topic-item.topic-completed:hover{color:var(--text-completed);background-color:transparent}.topic-item.topic-completed::before{color:var(--bullet-completed)}.kanban-board{display:grid;grid-template-columns:repeat(3,1fr);gap:20px;height:100%}.kanban-column{background-color:var(--plan-bg);border-radius:12px;display:flex;flex-direction:column;max-height:100%}.kanban-column-header{padding:15px 20px;border-bottom:1px solid var(--main-border);display:flex;align-items:center;gap:10px;position:sticky;top:0;background-color:var(--plan-bg);z-index:10}.kanban-column-header h2{font-size:1.1rem;font-weight:600}#col-todo .kanban-column-header h2,#col-todo .kanban-column-header i{color:var(--color-todo)}#col-inprogress .kanban-column-header h2,#col-inprogress .kanban-column-header i{color:var(--color-inprogress)}#col-done .kanban-column-header h2,#col-done .kanban-column-header i{color:var(--color-done)}.cards-container{flex-grow:1;padding:10px 20px 20px;overflow-y:auto;scrollbar-width:thin;scrollbar-color:var(--main-border) var(--plan-bg)}.specialty-header{display:flex;flex-direction:column;gap:5px;margin:20px 0 10px;padding:10px;border-radius:6px;background-color:var(--meta-bg);border-left:4px solid}.specialty-header-main{display:flex;justify-content:space-between;align-items:center}.specialty-header-main h3{font-size:1.1rem;font-weight:700;margin:0}.specialty-progress-wrapper{display:flex;align-items:center;gap:8px}.specialty-progress-wrapper small{font-size:.7rem;color:var(--meta-text);width:40px;flex-shrink:0}.specialty-progress-container{flex-grow:1;height:8px;background-color:var(--main-border);border-radius:4px}.specialty-progress-bar{height:100%;width:0;border-radius:4px;transition:all .3s ease;background-color:var(--progress-advance-bg)}.specialty-score-bar{height:100%;width:0;border-radius:4px;transition:all .3s ease}.specialty-score-bar.low{background-color:var(--error-color)}.specialty-score-bar.medium{background-color:var(--warning-color)}.specialty-score-bar.high{background-color:var(--vfd-green)}.specialty-percentage-text{font-size:.8em;font-weight:600;color:var(--text-secondary);width:45px;text-align:right;flex-shrink:0}.kanban-card{background-color:var(--cell-bg);border-radius:8px;margin-bottom:10px;box-shadow:0 2px 8px var(--shadow-color);cursor:pointer;transition:border-left-color .3s}.kanban-card:hover{background-color:var(--meta-bg)}.card-summary{padding:12px 15px}.card-topic-name{font-weight:600}.card-progress-display{display:flex;align-items:center;gap:15px;margin-top:10px}.card-progress-bar-container{flex-grow:1;height:6px;background-color:var(--main-border);border-radius:3px}.card-progress-bar{height:100%;width:0;border-radius:3px;transition:width .3s ease}.card-progress-text,.card-score-text{font-size:.75rem;font-weight:600;color:var(--text-secondary)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);z-index:998;display:none;opacity:0;transition:opacity .3s ease}.modal-overlay.visible{display:block;opacity:1}.modal-container{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background-color:var(--cell-bg);border:1px solid var(--main-border);border-radius:12px;box-shadow:0 5px 25px rgba(0,0,0,.5);z-index:1000;width:90%;max-height:90vh;display:none;flex-direction:column;transition:transform .3s ease,opacity .3s ease}.modal-container.visible{display:flex}.modal-header{padding:15px 25px;border-bottom:1px solid var(--main-border);display:flex;justify-content:space-between;align-items:center}.modal-header h2{margin:0;font-family:'Orbitron',sans-serif;font-size:1.5em}.modal-close{font-size:2em;color:#888;cursor:pointer;line-height:1;transition:color .2s}.modal-close:hover{color:var(--text-color)}.modal-content{padding:25px;overflow-y:auto}#details-modal{max-width:650px;z-index:1000}#details-modal .modal-header h2{color:var(--accent-color)}#modal-notes{width:100%;box-sizing:border-box;min-height:120px;background-color:#2c2c2c;border:1px solid var(--main-border);color:var(--text-color);padding:10px;resize:vertical;border-radius:4px}#modal-save-btn{width:100%;padding:12px;margin-top:10px;background-color:var(--accent-color);color:var(--bg-color);border:none;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:1em;border-radius:4px;transition:background-color .2s,transform .1s}#modal-save-btn:hover{background-color:#39ff94}#modal-save-btn:active{transform:scale(.98)}#topic-plan-modal{max-width:900px;z-index:1001;background-color:var(--bg-color)}#topic-plan-modal .modal-header h2{color:var(--vfd-green);font-size:1.3em}#topic-plan-modal .modal-content{padding:15px 25px}.study-flow-diagram{display:flex;flex-direction:column;gap:15px;width:100%}.step-card{border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,.3);padding:12px 18px;display:flex;align-items:flex-start;transition:opacity .3s ease,border-left-color .3s ease;border-left-style:solid;border-left-width:5px;background-color:var(--plan-bg)}.step-card.completed{border-left-color:#505050!important;opacity:.65}.step-card.completed .step-icon-container,.step-card.completed .step-title,.step-card.completed .step-details li{color:#909090!important}.step-card.completed .step-number{background-color:#383838!important;color:#787878!important}.step-icon-container{font-size:1.8em;margin-right:15px;padding-top:2px;min-width:35px;text-align:center}.step-content{flex-grow:1}.step-title{font-size:1.2em;font-weight:600;margin:0 0 10px;display:flex;align-items:center;color:var(--text-color)}.step-title .subtitle{font-size:.7em;color:#999;margin-left:8px;font-weight:400;text-transform:none}.step-number{color:#101010;border-radius:50%;width:26px;height:26px;display:inline-flex;align-items:center;justify-content:center;font-size:.7em;font-weight:700;margin-right:8px;flex-shrink:0}.step-details{list-style:none;padding-left:0;margin:0}.step-details li{margin-bottom:8px;font-size:.9em;line-height:1.4;display:flex;align-items:center;color:var(--meta-text)}.step-details li label{display:flex;align-items:center;cursor:pointer;width:100%}.task-checkbox{margin-right:10px;accent-color:var(--vfd-green);transform:scale(1.1)}.task-text{transition:text-decoration .3s ease,color .3s ease}input[type=checkbox]:checked+label .task-text,input[type=checkbox]:checked~.task-text{text-decoration:line-through;color:#6a6a6a}.optional-tag{font-size:.8em;color:#888;margin-left:5px;font-style:italic}.tool-tag{padding:2px 8px;border-radius:12px;font-size:.75em;font-weight:600;margin-left:8px;border:1px solid}.tag-madera{background-color:#c8e6c9;color:var(--tag-text-dark);border-color:#a5d6a7}.tag-ia{background-color:#bbdefb;color:var(--tag-text-dark);border-color:#90caf9}.tag-genspark{background-color:#ffecb3;color:var(--tag-text-dark);border-color:#ffe082}.tag-notebooklm{background-color:#d1c4e9;color:var(--tag-text-dark);border-color:#b39ddb}.step-1{border-left-color:var(--step-1-color)}.step-1 .step-icon-container{color:var(--step-1-color)}.step-1 .step-number{background-color:var(--step-1-color)}.step-2{border-left-color:var(--step-2-color)}.step-2 .step-icon-container{color:var(--step-2-color)}.step-2 .step-number{background-color:var(--step-2-color)}.step-3{border-left-color:var(--step-3-color)}.step-3 .step-icon-container{color:var(--step-3-color)}.step-3 .step-number{background-color:var(--step-3-color)}.step-4{border-left-color:var(--step-4-color)}.step-4 .step-icon-container{color:var(--step-4-color)}.step-4 .step-number{background-color:var(--step-4-color)}.step-5{border-left-color:var(--step-5-color)}.step-5 .step-icon-container{color:var(--step-5-color)}.step-5 .step-number{background-color:var(--step-5-color)}.step-6{border-left-color:var(--step-6-color)}.step-6 .step-icon-container{color:var(--step-6-color)}.step-6 .step-number{background-color:var(--step-6-color)}.parallel-steps-container{display:flex;gap:15px}.parallel-steps-container .step-card{flex:1}.practice-step-layout{display:flex;flex-direction:row;gap:15px;width:100%}.practice-tasks-column{flex:2}.practice-score-column{flex:1}.practice-score-column h3{font-size:.9em;color:#ccc;margin:0 0 8px;font-weight:500;text-transform:uppercase}.score-inputs-row{display:flex;gap:8px}.score-input-group{flex-grow:1}.score-input-group label{font-size:.75em;color:#bbb}.score-input-group input{font-family:'Source Sans Pro',sans-serif;background-color:#2a2a2a;color:#e0e0e0;border:1px solid #444;border-radius:4px;padding:5px 8px;font-size:.9em;width:100%;box-sizing:border-box;text-align:center}.score-input-group input[type=number]::-webkit-inner-spin-button,.score-input-group input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}.score-input-group input[type=number]{-moz-appearance:textfield}.percentage-output{font-weight:700;background-color:var(--plan-bg)!important;cursor:default}.topic-modal-footer{margin-top:25px;padding-top:15px;border-top:1px solid var(--main-border);text-align:right}.topic-finish-btn{background-color:var(--vfd-green);color:var(--bg-color);border:none;border-radius:6px;padding:12px 25px;font-family:'Orbitron',sans-serif;font-size:1em;font-weight:700;text-transform:uppercase;cursor:pointer;transition:background-color .2s ease,transform .2s ease}.topic-finish-btn:hover{background-color:#76ff76;transform:translateY(-2px)}#auth-modal{max-width:400px;z-index:1002}#auth-modal .modal-content{display:flex;flex-direction:column;gap:15px}#auth-modal input{width:100%;padding:12px;background-color:#2c2c2c;border:1px solid var(--main-border);color:var(--text-color);border-radius:4px;font-size:1em}#auth-modal button{width:100%;padding:12px;background-color:var(--accent-color);color:var(--bg-color);border:none;cursor:pointer;font-family:'Orbitron',sans-serif;font-size:1em;border-radius:4px;transition:background-color .2s,transform .1s}#auth-modal button:hover{background-color:#39ff94}#auth-modal .form-switcher{font-size:.9em;text-align:center;color:var(--text-secondary)}#auth-modal .form-switcher span{color:var(--accent-color);cursor:pointer;text-decoration:underline}#auth-error-message{color:var(--error-color);font-size:.9em;text-align:center;min-height:1.2em;font-weight:600}#register-form{display:none}@media (max-width:768px){.motivational-quote{font-size:1.2em}.countdown-digits{font-size:3em}.countdown-timer-container{gap:15px}.parallel-steps-container,.practice-step-layout,.kanban-board{flex-direction:column;display:block}.kanban-column{margin-bottom:20px}.day-cell{min-height:120px}}@media (max-width:600px){.banner-bottom-row{flex-direction:column;align-items:stretch}.auth-container{justify-content:space-between}.motivational-quote{font-size:1em;letter-spacing:1px}.countdown-digits{font-size:2.2em}.countdown-label{font-size:.6em}.countdown-timer-container{gap:10px}body{padding:0}.view-wrapper{padding:10px}.calendar-container{grid-template-columns:30px 30px repeat(7,1fr)}.modal-content{padding:15px}.step-card{flex-direction:column}.step-icon-container{text-align:left;margin-bottom:5px}#edit-countdown-btn{right:-5px;top:-15px}}
    </style>
</head>
<body>
    <header class="app-banner">
        <div id="motivational-quote-container" class="motivational-quote"></div>
        <div class="countdown-container">
            <div class="countdown-timer-container">
                <div class="countdown-unit"><div class="countdown-label">Days</div><div class="countdown-digits" id="countdown-days">000</div></div>
                <div class="countdown-unit"><div class="countdown-label">Hours</div><div class="countdown-digits" id="countdown-hours">00</div></div>
                <div class="countdown-unit"><div class="countdown-label">Minutes</div><div class="countdown-digits" id="countdown-minutes">00</div></div>
                <div class="countdown-unit"><div class="countdown-label">Seconds</div><div class="countdown-digits" id="countdown-seconds">00</div></div>
            </div>
            <button id="edit-countdown-btn" title="Editar fecha final"><i class="fas fa-calendar-alt"></i></button>
        </div>
        <div id="countdown-editor">
            <input type="date" id="countdown-date-picker">
            <button id="save-countdown-btn">Guardar</button>
        </div>
        <div class="banner-bottom-row">
            <div class="global-progress-container">
                <div class="progress-bar-wrapper">
                    <label id="global-score-label">Puntuación Global (Promedio de Calificaciones)</label>
                    <div class="progress-bar-background"><div class="progress-bar-fill" id="global-score-bar" role="progressbar">0%</div></div>
                </div>
                <div class="progress-bar-wrapper">
                    <label id="global-advance-label">Avance Global (Temas Completados)</label>
                    <div class="progress-bar-background"><div class="progress-bar-fill" id="global-advance-bar" role="progressbar">0%</div></div>
                </div>
            </div>
            <button id="view-switcher" class="view-switcher" data-current-view="calendar">
                <i class="fas fa-columns"></i> Tablero Vital
            </button>
             <div id="auth-container">
                <span id="user-display"></span>
                <button id="auth-btn" class="view-switcher"><i class="fas fa-user-circle"></i> Login / Registrarse</button>
            </div>
        </div>
    </header>

    <main class="main-content-area">
        <div id="calendar-view" class="view-wrapper">
            <div class="calendar-container" id="calendar-container"></div>
        </div>
        <div id="board-view" class="view-wrapper hidden">
            <main class="kanban-board">
                <section class="kanban-column" id="col-todo">
                    <div class="kanban-column-header"><h2><i class="far fa-circle" style="margin-right: 8px;"></i>Sin Empezar</h2></div>
                    <div class="cards-container" id="col-todo-container"></div>
                </section>
                <section class="kanban-column" id="col-inprogress">
                    <div class="kanban-column-header"><h2><i class="fas fa-spinner" style="margin-right: 8px;"></i>En Curso</h2></div>
                    <div class="cards-container" id="col-inprogress-container"></div>
                </section>
                <section class="kanban-column" id="col-done">
                    <div class="kanban-column-header"><h2><i class="fas fa-check-circle" style="margin-right: 8px;"></i>Listo</h2></div>
                    <div class="cards-container" id="col-done-container"></div>
                </section>
            </main>
        </div>
    </main>
    
    <!-- Modal de Detalles del Día -->
    <div class="modal-overlay" id="modal-overlay"></div>
    <div class="modal-container" id="details-modal">
        <div class="modal-header"> <h2 id="modal-title"></h2> <span class="modal-close" id="modal-close-day">×</span> </div>
        <div class="modal-content"> <div id="modal-topics"></div> <div class="notes-section" style="margin-top: 20px;"> <h3>Mis Anotaciones del Día</h3> <textarea id="modal-notes" placeholder="Escribe aquí tus notas generales para este día..."></textarea> <button id="modal-save-btn">Guardar Nota</button> </div> </div>
    </div>

    <!-- Modal del Plan de Tema -->
    <div class="modal-overlay" id="topic-plan-overlay"></div>
    <div class="modal-container" id="topic-plan-modal">
        <div class="modal-header"> <h2 id="topic-plan-title"></h2> <span class="modal-close" id="modal-close-topic">×</span> </div>
        <div class="modal-content">
             <div class="study-flow-diagram">
                <div class="step-card step-1"> <div class="step-icon-container"><i class="fas fa-binoculars"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">1</span>VISTA RÁPIDA</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-1-1"><i class="fas fa-list-ul task-icon"></i><span class="task-text">Índice</span><span class="tool-tag tag-madera">MADERA</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-1-2"><i class="fas fa-download task-icon"></i><span class="task-text">Descargar guías</span><span class="optional-tag">* opcional</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-1-3"><i class="fas fa-brain task-icon"></i><span class="task-text">CREA resúmenes + casos con IA (5min)</span><span class="tool-tag tag-ia">IAGOOGLE</span></label></li> </ul> </div> </div>
                <div class="parallel-steps-container"> <div class="step-card step-2"> <div class="step-icon-container"><i class="fas fa-magic"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">2</span>CREAR</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-2-1"><i class="fas fa-chalkboard-teacher task-icon"></i><span class="task-text">Presentación</span><span class="tool-tag tag-genspark">Genspark</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-2-2"><i class="fas fa-microphone-alt task-icon"></i><span class="task-text">Podcast MP3</span><span class="tool-tag tag-notebooklm">NOTEBOOKLM</span></label></li> </ul> </div> </div> <div class="step-card step-3"> <div class="step-icon-container"><i class="fas fa-book-reader"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">3</span>LEER</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-3-1"><i class="fas fa-file-alt task-icon"></i><span class="task-text">Leer Resumen</span></label></li> </ul> </div> </div> </div>
                <div class="step-card step-4"> <div class="step-icon-container"><i class="fas fa-puzzle-piece"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">4</span>UNIFICAR<span class="subtitle">(resumen + presentación + simular + enlaces)</span></h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-4-1"><i class="fas fa-code task-icon"></i><span class="task-text">HTML</span><span class="tool-tag tag-ia">IAGOOGLE</span></label></li> </ul> </div> </div>
                <div class="step-card step-5"> <div class="step-icon-container"><i class="fas fa-tasks"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">5</span>PRACTICAR</h2> <div class="practice-step-layout"> <div class="practice-tasks-column"> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-5-1"><i class="fas fa-notes-medical task-icon"></i><span class="task-text">Realiza CASOS CLÍNICOS</span></label></li> <li><label><input type="checkbox" class="task-checkbox" id="task-5-2"><i class="fas fa-redo-alt task-icon"></i><span class="task-text">Repasar</span><span class="tool-tag tag-genspark">GENSPARK</span><span class="tool-tag tag-madera">MADERAS</span></label></li> </ul> </div> <div class="practice-score-column"> <h3>PUNTUACIÓN</h3> <div class="score-inputs-row"> <div class="score-input-group"><label for="score-aciertos">Aciertos:</label><input type="number" id="score-aciertos" min="0"></div> <div class="score-input-group"><label for="score-reactivos">Reactivos:</label><input type="number" id="score-reactivos" min="0"></div> <div class="score-input-group"><label for="score-percentage">%:</label><input type="text" id="score-percentage" class="percentage-output" readonly value="0%"></div> </div> </div> </div> </div> </div>
                <div class="step-card step-6"> <div class="step-icon-container"><i class="fas fa-head-side-headphones"></i></div> <div class="step-content"> <h2 class="step-title"><span class="step-number">6</span>MEMORIZAR</h2> <ul class="step-details"> <li><label><input type="checkbox" class="task-checkbox" id="task-6-1"><i class="fas fa-headphones-alt task-icon"></i><span class="task-text">Escuchar MP3</span></label></li> </ul> </div> </div>
            </div>
            <div class="topic-modal-footer"> <button id="topic-finish-btn" class="topic-finish-btn">Terminar Tema</button> </div>
        </div>
    </div>

    <!-- Modal de Autenticación -->
    <div class="modal-overlay" id="auth-modal-overlay"></div>
    <div class="modal-container" id="auth-modal">
        <div class="modal-header">
            <h2 id="auth-modal-title">Iniciar Sesión</h2>
            <span class="modal-close" id="auth-modal-close">×</span>
        </div>
        <div class="modal-content">
            <p id="auth-error-message"></p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Correo electrónico" required>
                <input type="password" id="login-password" placeholder="Contraseña" required>
                <button type="submit">Iniciar Sesión</button>
            </form>
            <form id="register-form">
                <input type="email" id="register-email" placeholder="Correo electrónico" required>
                <input type="password" id="register-password" placeholder="Contraseña (mín. 6 caracteres)" required>
                <button type="submit">Registrarme</button>
            </form>
            <p class="form-switcher" id="form-switcher-login">
                ¿No tienes cuenta? <span id="show-register-form">Regístrate</span>
            </p>
            <p class="form-switcher" id="form-switcher-register" style="display: none;">
                ¿Ya tienes cuenta? <span id="show-login-form">Inicia sesión</span>
            </p>
        </div>
    </div>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
      // Pega este código reemplazando el contenido de tu etiqueta <script>
    document.addEventListener('DOMContentLoaded', () => {

        // --- INICIO DE CONFIGURACIÓN DE FIREBASE ---
        const firebaseConfig = {
          apiKey: "AIzaSyCFJfQPG-KNDnNKUWHrALTRWnT_22qQXN4",
          authDomain: "cal75-bebe6.firebaseapp.com",
          projectId: "cal75-bebe6",
          storageBucket: "cal75-bebe6.appspot.com",
          messagingSenderId: "1016604789346",
          appId: "1:1016604789346:web:6862cfeb5666e3ec8c5f3b",
          measurementId: "G-BZLV6H2ER9"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUser = null; 
        
        const initializeAppLogic = () => {
            const subjectToTopicsMap = new Map();
            const motivationalQuotes = [ "La disciplina es el puente entre metas y logros.", "El éxito es la suma de pequeños esfuerzos repetidos día tras día.", "No te detengas hasta que te sientas orgulloso.", "Cree en ti mismo y todo será posible.", "El único modo de hacer un gran trabajo es amar lo que haces." ];
            let studyPlan, userProgress = {}, countdownTargetDateStr, countdownInterval = null;
            const ALL_TASK_IDS = ['task-1-1', 'task-1-2', 'task-1-3', 'task-2-1', 'task-2-2', 'task-3-1', 'task-4-1', 'task-5-1', 'task-5-2', 'task-6-1'];
            
            let calendarView, boardView, viewSwitcher, calendarContainer, todoContainer, inprogressContainer, doneContainer;
            let dayModal, dayModalOverlay, dayModalTitle, dayModalTopicsContainer, dayModalNotes, saveNoteButton;
            let topicModal, topicModalOverlay, topicModalTitle, topicStepCards, topicTaskCheckboxes, aciertosInput, reactivosInput, percentageOutput, finishTopicButton;
            let globalScoreBar, globalAdvanceBar;
            let editCountdownBtn, countdownEditor, countdownDatePicker, saveCountdownBtn, quoteContainer;
            let authModal, authModalOverlay, authModalCloseBtn, authModalTitle, loginForm, registerForm, authErrorMessage, showRegisterBtn, showLoginBtn;

            function assignDOMelements() {
                calendarView = document.getElementById('calendar-view'); boardView = document.getElementById('board-view'); viewSwitcher = document.getElementById('view-switcher'); calendarContainer = document.getElementById('calendar-container'); todoContainer = document.getElementById('col-todo-container'); inprogressContainer = document.getElementById('col-inprogress-container'); doneContainer = document.getElementById('col-done-container'); dayModal = document.getElementById('details-modal'); dayModalOverlay = document.getElementById('modal-overlay'); dayModalTitle = document.getElementById('modal-title'); dayModalTopicsContainer = document.getElementById('modal-topics'); dayModalNotes = document.getElementById('modal-notes'); saveNoteButton = document.getElementById('modal-save-btn'); topicModal = document.getElementById('topic-plan-modal'); topicModalOverlay = document.getElementById('topic-plan-overlay'); topicModalTitle = document.getElementById('topic-plan-title'); topicStepCards = topicModal.querySelectorAll('.step-card'); topicTaskCheckboxes = topicModal.querySelectorAll('.task-checkbox'); aciertosInput = document.getElementById('score-aciertos'); reactivosInput = document.getElementById('score-reactivos'); percentageOutput = document.getElementById('score-percentage'); finishTopicButton = document.getElementById('topic-finish-btn'); globalScoreBar = document.getElementById('global-score-bar'); globalAdvanceBar = document.getElementById('global-advance-bar'); editCountdownBtn = document.getElementById('edit-countdown-btn'); countdownEditor = document.getElementById('countdown-editor'); countdownDatePicker = document.getElementById('countdown-date-picker'); saveCountdownBtn = document.getElementById('save-countdown-btn'); quoteContainer = document.getElementById('motivational-quote-container');
                authModal = document.getElementById('auth-modal'); authModalOverlay = document.getElementById('auth-modal-overlay'); authModalCloseBtn = document.getElementById('auth-modal-close'); authModalTitle = document.getElementById('auth-modal-title'); loginForm = document.getElementById('login-form'); registerForm = document.getElementById('register-form'); authErrorMessage = document.getElementById('auth-error-message'); showRegisterBtn = document.getElementById('show-register-form'); showLoginBtn = document.getElementById('show-login-form');
            }

            function openAuthModal() { authErrorMessage.textContent = ''; authModal.classList.add('visible'); authModalOverlay.classList.add('visible'); }
            function closeAuthModal() { authModal.classList.remove('visible'); authModalOverlay.classList.remove('visible'); }
            function handleRegistration(e) { e.preventDefault(); const email = document.getElementById('register-email').value; const password = document.getElementById('register-password').value; auth.createUserWithEmailAndPassword(email, password).then(userCredential => { closeAuthModal(); }).catch(error => { authErrorMessage.textContent = error.message; }); }
            function handleLogin(e) { e.preventDefault(); const email = document.getElementById('login-email').value; const password = document.getElementById('login-password').value; auth.signInWithEmailAndPassword(email, password).then(userCredential => { closeAuthModal(); }).catch(error => { authErrorMessage.textContent = "Correo o contraseña incorrectos."; }); }
            function saveData(key, value) { if (!currentUser) { return; } const keys = key.split('.'); let currentLocal = userProgress; for (let i = 0; i < keys.length - 1; i++) { currentLocal = currentLocal[keys[i]] = currentLocal[keys[i]] || {}; } currentLocal[keys[keys.length - 1]] = value; clearTimeout(window.saveTimeout); window.saveTimeout = setTimeout(() => { db.collection('userProgress').doc(currentUser.uid).set({ progressData: userProgress }, { merge: true }).catch(error => console.error("Error al sincronizar:", error)); }, 1500); }
            async function loadProgressFromFirestore() { if (!currentUser) return; const docRef = db.collection('userProgress').doc(currentUser.uid); const doc = await docRef.get(); if (doc.exists && doc.data().progressData) { userProgress = doc.data().progressData; } else { userProgress = {}; seedInitialProgress(); } studyPlan = getData('studyPlan'); if (!studyPlan) { studyPlan = generateStudyPlan(); saveData('studyPlan', studyPlan); } countdownTargetDateStr = getData('countdownTarget', '2025-09-23'); countdownDatePicker.value = countdownTargetDateStr; startCountdown(); populateCalendar(); updateGlobalProgressBars(); }
            function generateTopicId(topicName) { return `topic_${topicName.toLowerCase().replace(/[^a-z0-9]/g, '')}`; }
            function seedInitialProgress() { const initialData = { "ORL": { "Epistaxis": {aciertos: 8, reactivos: 9}, "VPPB": {aciertos: 9, reactivos: 9}, "Parálisis de Bell": {aciertos: 6, reactivos: 9}, "Neuralgia de trigémino": {aciertos: 1, reactivos: 14}, "Neuritis vestibular": {aciertos: 6, reactivos: 9}, "Fracturas nasales": {aciertos: 8, reactivos: 9}, "Rinosinusitis": {aciertos: 6, reactivos: 9}, "Faringoamigdalitis": {aciertos: 6, reactivos: 9}, "Angina de Ludwig": {aciertos: 6, reactivos: 9}, "Otitis": {aciertos: 7, reactivos: 9}, "Mastoiditis aguda": {aciertos: 5, reactivos: 9} }, "OFTALMOLOGÍA": { "Blefaritis": { aciertos: 5, reactivos: 9 }, "Orzuelo": { aciertos: 6, reactivos: 9 }, "Conjuntivitis (alergica, bacteriana, neonatal, viral)": { aciertos: 16, reactivos: 21 }, "Chalazión": { aciertos: 9, reactivos: 9 }, "Glaucoma de ángulo abierto": { aciertos: 3, reactivos: 9 }, "Glaucoma de ángulo cerrado": { aciertos: 5, reactivos: 9 }, "Glaucoma congénito": { aciertos: 8, reactivos: 9 }, "Degeneración macular": { aciertos: 0, reactivos: 0 }, "Desprendimiento de retina": { aciertos: 0, reactivos: 0 }, "Retinopatía diabética": { aciertos: 4, reactivos: 9 }, "Retinopatía hipertensiva": { aciertos: 5, reactivos: 9 }, "Catarata": { aciertos: 7, reactivos: 9 }, "Trauma ocular": { aciertos: 15, reactivos: 18 }, "Ojo rojo": { aciertos: 7, reactivos: 9 } }}; if (!getData('topicData')) { userProgress.topicData = {}; for (const specialty in initialData) { for (const topic in initialData[specialty]) { const topicId = generateTopicId(topic); const data = initialData[specialty][topic]; userProgress.topicData[topicId] = { scoreAciertos: data.aciertos, scoreReactivos: data.reactivos, }; ALL_TASK_IDS.forEach((taskId, index) => { userProgress.topicData[topicId][taskId] = true; }); } } } }
            function generateStudyPlan() {
                const topicsBySpecialtyPart1 = { "UROLOGÍA": [ "Escroto agudo", "Torsión testicular", "Hiperplasia prostática benigna", "Cáncer de próstata", "Pielonefritis aguda", "Infección de tracto urinario", "Urolitiasis", "Orquiepididimitis", "Cáncer testicular", "Disfunción eréctil", "Estenosis del meato urinario", "Hidrocele", "Varicocele", "Prostatitis aguda", "Cáncer de vejiga", "Cáncer renal", "Incontinencia urinaria", "Retención aguda de orina" ], "ENDOCRINOLOGÍA": [ "Diabetes mellitus", "Prediabetes", "Diabetes en el adulto mayor", "Diabetes en pediatría", "Cetoacidosis diabética y EHH", "Hipoglucemia", "Enfermedad de Addison", "Enfermedad de Cushing / Síndrome de Cushing", "Hiperprolactinemia", "Acromegalia", "Feocromocitoma", "Hiperaldosteronismo", "Hiperparatiroidismo", "Neoplasia endocrina múltple", "Alopecia endocrina" ], "INFECTOLOGÍA": [ "Brucelosis", "Cisticercosis", "Clostridium", "Diarrea aguda en adultos", "Diarrea en niños", "Chinkungunya", "Dengue", "Zika", "Paludismo", "Salmonella Fiebre tifoidea", "Sepsis y choque séptico", "Tuberculosis pulmonar", "ETS Generalidades", "VIH Adultos", "VIH Madre e hijo", "RV yOportunistas", "Sarcoma de Kaposi", "Giardiasis", "Tuberculosis extrapulmonar", "Lepra", "Medios de cultivo", "Actinomicosis", "Amebiasis intestinal", "Anquilostomiasis", "Ascariasis", "Aspergilosis", "Coccidioidomicosis", "Difteria", "Enfermedad de Chagas", "Enfermedad de Lyme", "Estrongiloidiasis", "Fascitis necrosante", "Fiebre de origen desconocido", "Filariasis linfática", "Filariasis ocular Loasis", "Infecciones odontogénicas", "Leishmaniasis", "Leptospirosis", "Mucormicosis", "Oncocercosis", "Oxiuriasis o enterobiasis", "Poliomielitis", "Rabia", "Tricuriasis", "Triquinosis", "Neumonía adquirida en la comunidad", "Neumonía bacteriana adquirida en la comunidad Niños", "Influenza", "Meningitis", "Encefalitis viral", "Absceso cerebral" ], "HEMATOLOGÍA": [ "Anemia generalidades", "Anemia ferropénica Adultos", "Leucemias", "Linfomas", "Trombocitopenia inmune" ], "NEUROLOGÍA": [ "Cefalea Secundarias", "Cefaleas primarias", "Crisis convulsivas", "Estatus epiléptico", "Crisis febriles", "Enfermedad de Parkinson", "Evc isquémico", "Hemorragia subaracnoidea", "Guillain Barré", "Esclerosis múltiple", "Evc hemorrágico", "Miastenia gravis", "Muerte encefálica" ], "NEUMOLOGÍA": [ "Asma en pediátricos", "Exacerbación de asma", "Cáncer de pulmón", "Epoc", "Derrame pleural", "Tabaquismo" ], "REUMATOLOGÍA": [ "Artritis reactiva", "Artritis reumatoide", "Espondilitis anquilosante", "Gota", "Lupus eritematoso sistémico", "Arteritis de la temporal", "Granulomatosis de Wegener", "Artritis séptica" ], "NEFROLOGÍA": [ "Lesión renal aguda", "Enfermedad renal crónica", "Nefropatía diabética", "Síndrome nefrítico y nefrootico", "Trastorno ácido-base", "Nefritis lúpica" ], "DERMATOLOGÍA": [ "Dermatitis atópica", "Dermatofitosis", "SSJ y NET", "Escabiosis - Sarna", "Impétigo", "Melanoma", "Psoriasis", "Carcinoma basocelular", "Acné vulgar", "Erisipela", "Urticaria", "Dermatitis por contacto", "Pediculosis capitis", "Síndrome de Ritter", "Carcinoma espinocelular" ], "PSIQUIATRÍA": [ "Abuso de sustancias", "Abstinencia alcohólica", "Trastorno por alcohol", "Esquizofrenia", "Estrés post traumático", "Trastornos del sueño", "Intento de suicidio", "Tdah", "Trastorno bipolar", "Trastornos de ansiedad", "Trastornos de conducta alimentaria", "Consumo de mariguana", "Violencia contra la mujer", "Autismo", "Síndrome de Munchausen" ], "GERIATRÍA": [ "Valoración geriátrica", "Alzheimer", "Delirium", "Demencia vascular", "Deterioro cognitivo", "Insomnio en el adulto mayor", "Síndrome de caídas", "Síndrome de fragilidad", "Maltrato en el adulto mayor", "Colapso del cuidador", "Depresión mayor" ], "GENÉTICA": [ "Síndrome de Down", "Síndrome de Klinefelter", "Síndrome de Turner", "Síndrome de Marfan", "Enfermedad de Wilson", "Síndrome de Dravet", "Síndrome de Lynch", "Síndrome de Peutz Jegher", "Von Hippel Lindau" ] };
                let allTopicsToSchedulePart1 = [];
                Object.keys(topicsBySpecialtyPart1).reverse().forEach(specialty => { topicsBySpecialtyPart1[specialty].reverse().forEach(topic => { allTopicsToSchedulePart1.unshift({ specialty, topic }); }); });
                let plannedDaysPart1 = [];
                let currentDatePart1 = new Date('2025-06-30');
                while (allTopicsToSchedulePart1.length > 0) {
                    currentDatePart1.setDate(currentDatePart1.getDate() - 1);
                    const chunkSize = Math.min(allTopicsToSchedulePart1.length, Math.floor(Math.random() * (8 - 4 + 1)) + 4);
                    const chunk = allTopicsToSchedulePart1.splice(0, chunkSize);
                    const dayData = { date: currentDatePart1.toISOString().split('T')[0], blocks: [] };
                    let lastSpecialty = null;
                    chunk.forEach(item => { if (item.specialty !== lastSpecialty) { dayData.blocks.push({ subject: item.specialty, topics: [item.topic] }); lastSpecialty = item.specialty; } else { dayData.blocks[dayData.blocks.length - 1].topics.push(item.topic); } });
                    plannedDaysPart1.push(dayData);
                }
                const oftalmoDays = [ { date: "2025-06-30", blocks: [ { subject: "OFTALMOLOGÍA", topics: ["Blefaritis", "Orzuelo", "Conjuntivitis (alergica, bacteriana, neonatal, viral)", "Chalazión", "Glaucoma de ángulo aberto", "Glaucoma de ángulo cerrado", "Glaucoma congénito"] } ] }, { date: "2025-07-01", blocks: [ { subject: "OFTALMOLOGÍA", topics: ["Degeneración macular", "Desprendimiento de retina", "Retinopatía diabética", "Retinopatía hipertensiva", "Catarata", "Trauma ocular", "Ojo rojo"] } ] } ];
                const orlDays = [ { date: "2025-07-02", blocks: [ { subject: "ORL", topics: ["Epistaxis", "VPPB", "Parálisis de Bell", "Neuralgia de trigémino", "Neuritis vestibular"] } ] }, { date: "2025-07-03", blocks: [ { subject: "ORL", topics: ["Fracturas nasales", "Rinosinusitis", "Faringoamigdalitis", "Angina de Ludwig", "Otitis", "Mastoiditis aguda"] } ] } ];
                const newTopicsBySpecialty = { "TYO": ["Osteoartritis", "Osteomielitis", "Osteosarcoma", "Sarcoma de Ewing", "Tumores óseos malignos", "Embolia grasa", "Costilla cervical", "Esguince cervical", "Lumbalgia", "Hernia de disco", "Túnel del carpo", "Síndrome de hombro doloroso", "Fractura de clavícula", "Fractura de húmero proximal", "Luxación glenohumeral", "Luxación de codo", "Codo de niñera", "Fracturas de codo", "Fracturas de antebrazo", "Fractura de radio distal", "Lesiones fisiarias", "Fracturas expuestas", "Fractura de cadera", "Epifisiolistesis femoral", "Legg Calvé Perthes", "Luxación coxofemoral", "Lesiones de rodilla", "Fractura de diáfisis de tibia", "Esguince de tobillo", "Fractura de tobillo", "Rotura de talón de Aquiles", "Pie equino varo", "Pie plano"], "CARDIOLOGÍA": ["Fiebre reumática", "Estenosis aórtica", "Insuficiencia aórtica", "Estenosis mitral", "Insuficiencia mitral", "Otras valvulopatías", "Pericarditis", "Endocarditis infecciosa", "Infarto agudo de miocardio", "Enfermedad coronaria", "Disección aórtica", "Aneurisma aórtico abdominal", "Cor pulmonar crónico", "Hipertensión arterial sistémica", "Crisis hipertensivas", "Hipertensión pulmonar", "Insuficiencia cardíaca aguda", "Insuficiencia cardíaca crónica", "Edema pulmonar", "Hipotensión ortostática", "Rehabilitación cardíaca"], "ANGIOLOGÍA": ["Enfermedad arterial periférica", "Insuficiencia venosa", "Pie diabético", "Trombosis venosa profunda", "Tromboembolia pulmonar", "Paget Schroetter", "Tromboembolia venosa en obstetricia", "Úlceras por presión"], "ACLS": ["Soporte vital básico", "RCP", "Taquicardia ACLS", "Taquicardia supraventricular", "Bloqueos AV", "Bradicardia", "Fibrilación auricular", "Fibrilación ventricular", "Síndrome de WPW", "PLS", "Ahogamiento"], "ATLS": ["Politrauma", "Tipos de shock", "Choque hipovolémico", "Shock neurogénico", "TCE adultos", "TCE pediátrico", "Fracturas de cráneo", "Trauma torácico", "Hemotórax", "Neumotórax a tensión", "Neumotórax aberto", "Neumotórax simple", "Taponamiento cardíaco", "Lesión traqueobronquial", "Trauma abdominal", "Ruptura diafragmática", "Trauma esplénico", "Trauma espinal", "Trauma pélvico", "Trauma obstétrico", "Quemaduras", "Gran quemado", "Catéter venoso central", "Hipotermia"], "TOXICOLOGÍA": ["Manejo de intoxicaciones", "Toxíndromes", "Intoxicación por benzodiacepinas", "Intoxicación por organofosforados", "Intoxicación por paracetamol", "Intoxicación por salicilatos", "Intoxicación por etanol", "Intoxicación por monóxido de carbono", "Intoxicación por opiáceos", "Intoxicación por anfetaminas", "Intoxicación por fentanilo", "Intoxicación por DMT", "Intoxicación por hidrocarburos", "Intoxicación por metales pesados", "Intoxicación por plomo", "Intoxicación por alcoholes", "Ingesta de cáusticos", "Intoxicación alimentaria", "Anafilaxia", "Picadura de alacrán", "Mordedura de serpiente", "Lactrodectus", "Loxosceles", "Picadura de himenópteros", "Golpe de calor"], "GASTROENTEROLOGÍA": ["Reflujo ERGE", "Enfermedad ácido péptica", "Síndrome de intestino irritable", "Dispepsia funcional", "Mallory Weiss", "Zollinger Ellison", "Acalasia", "Esófago de Barrett", "Enfermedad celíaca", "Enfermedad de Crohn", "Colitis ulcerativa", "Enfermedad diverticular", "Sangrado TDA", "Sangrado TDB", "Varices esofágicas", "EHGNA", "Hepatitis A", "Hepatitis B", "Hepatitis C", "Hepatitis autoinmune", "Absceso hepático amebiano", "Absceso hepático piógeno", "Cirrosis hepática", "Insuficiencia hepática", "Ascitis", "Encefalopatía hepática", "Pancreatitis aguda", "Pancreatitis crónica", "Cáncer gástrico", "Cáncer de esófago", "Cáncer de páncreas", "Carcinoma hepatocelular"], "CIRUGÍA ABDOMINAL Y COLOPROCTOLOGÍA": ["Apendicitis aguda", "Apendicitis en el embarazo", "Hernias", "Hernia inguinal", "Hernia femoral", "Hernia hiatal", "Hernia umbilical", "Hernia ventral", "Colecistitis aguda", "Colelitiasis", "Coledocolitiasis", "Colangitis aguda", "Oclusión intestinal", "Isquemia intestinal", "Vólvulo de sigmoides", "Vólvulo de ciego", "Enfermedad hemorroidal", "Fístula anal", "Fisura anal", "Absceso anal", "Quiste pilonidal", "Cáncer colorrectal", "Poliposis adenomatosa familiar PAF", "Fístulas biliointestinales", "Colangiocarcinoma", "Complicaciones post Qx", "Heridas quirúrgicas"], "CIRUGÍA PEDIÁTRICA": ["Atresia esofágica", "Atresia duodenal", "Atresia yeyunoileal", "Atresia biliar", "Atresia de coanas", "Estenosis pilórica", "Hernia diafragmática congénita", "Malrotación intestinal", "Invaginación intestinal", "Divertículo de Meckel", "Hirschsprung", "Enfermedad de Hirschsprung", "Patología umbilical", "Criptorquidia", "Espina bífida", "Malformaciones rectales", "Retinoblastoma", "Nefroblastoma", "Neuroblastoma", "Tumor abdominal"], "GINECOLOGÍA": ["Amenorreas primarias", "Amenorreas secundarias", "Sangrado uterino anormal", "Dismenorrea aguda", "Adenomiosis", "Endometriosis", "Miomatosis uterina", "Hiperplasia endometrial", "Quiste de ovario benigno", "Torsión ovárica", "Ovario poliquístico", "Enfermedad pélvica inflamatoria", "Hidrosalpinx", "Fitz-Hugh-Curtis", "Vaginitis bacteriana", "Vaginitis infecciosa", "Tricomoniasis", "Bartolinitis", "Candidiasis vulvovaginal", "Chlamydia", "Mastitis", "Mastopatía fibroquística", "Fibroadenoma", "Papiloma intraductal", "Quiste mamario", "Patología mamaria benigna", "Osteoporosis post menopausia", "Menopausia y climaterio", "Insuficiencia ovárica primaria", "Anticonceptivos generalidades", "Anticonceptivos GPC", "Anticonceptivos hormonales combinados", "Anticoncepción de emergencia", "DIU de cobre", "DIU de levonorgestrel", "Implante subdérmico", "Progestágenos solos", "Lactancia como anticonceptivo", "Condón", "Vasectomía", "Oclusión tubaria bilateral OTB", "Infertilidad", "Cistocele e incontinencia"], "ONCOGINE": ["Tamizaje cáncer de mama", "Cáncer de mama", "Cáncer cérvicouterino", "Cáncer de endometrio", "Cáncer de ovario", "Cáncer de vagina", "Tumores anexiales"], "OBSTETRICIA": ["Control prenatal", "Aloinmunización materna", "Estática fetal", "Tipos de pelvis", "Atención del parto", "Manejo activo del parto", "Cesárea", "Parto pretérmino", "Puerperio fisiológico", "Líquido amniótico", "Ruptura prematura de membranas", "Corioamnionitis", "Distocias", "Embarazo múltiple", "Endometritis puerperal", "Hiperémesis gravídica", "Insuficiencia cervical", "Muerte fetal", "Enfermedades hipertensivas del embarazo", "Preeclampsia sin datos de severidad", "Síndrome de HELLP", "Diabetes gestacional", "IVU en el embarazo", "Restricción del crecimiento intrauterino", "Sepsis puerperal", "Síndrome de Sheehan", "Depresión posparto"], "HEMORRAGIAS OBSTÉTRICAS": ["Generalidades de hemorragias", "Hemorragia postparto", "Desgarro perineal", "Amenaza de aborto", "Aborto espontáneo", "Acretismo placentario", "Atonía uterina", "Choque hemorrágico en obstetricia", "Desprendimiento prematuro de placenta normoinserta", "Embarazo ectópico", "Placenta previa", "Ruptura uterina", "Vasa previa", "Enfermedad trofoblástica gestacional"], "NEONATOLOGÍA": ["APGAR", "Reanimación neonatal", "Prematuro sano", "Recién nacido de término", "Apnea del prematuro", "Asfixia neonatal", "Síndrome de dificultad respiratoria", "Taquipnea transitoria del recién nacido", "Síndrome de aspiración de meconio", "Displasia broncopulmonar", "Silverman Anderson", "Maduración pulmonar", "Encefalopatía hipóxica", "Enfermedad hemorrágica del recién nacido", "Enterocolitis necrotizante", "Hipoacusia neonatal", "Hipoglucemia neonatal", "Ictericia neonatal", "Muerte súbita del lactante", "Sepsis neonatal", "Tamiz neonatal", "Lesiones de plexo braquial obstétrico", "Lesiones extracraneales", "Displasia del desarrollo de la cadera DDC"], "CONGENITAS": ["Cardiopatías congénitas", "Tetralogía de Fallot", "Coartación aórtica", "Persistencia del conducto arterioso", "Fibrosis quística", "Fenilcetonuria", "Galactosemia clásica", "STORCH", "STORCH Citomegalovirus", "STORCH Herpes simple", "STORCH Rubéola congénita", "STORCH Sífilis congénita", "STORCH Toxoplasmosis", "STORCH Varicela congénita"], "ESCOLAR": ["Control de niño sano", "Etapas del crecimiento", "Talla baja", "Alergia alimentaria", "Cuerpo extraño", "Dermatitis del pañal", "Estreñimiento funcional", "Hiperplasia adrenal congénita", "Hipotiroidismo congénito", "Maltrato infantil", "Mucopolisacaridosis", "Reflujo gastroesofágico del lactante"], "NUTRICIÓN PEDIÁTRICA": ["Lactancia materna", "Alimentación complementaria", "Desnutrición pediátrica", "Deficiencia de vitamina A", "Hipovitaminosis", "Raquitismo carencial", "Pelagra en niños", "Intolerancia a la lactosa", "Obesidad en escolares", "Síndrome metabólico en niños"], "INFECTOLOGÍA PEDIÁTRICA": ["Adenitis mesentérica", "Onfalitis", "Exantemáticas Diferencial", "Eritema infeccioso", "Escarlatina", "Exantema súbito", "Enfermedad de Kawasaki", "Síndrome mano pie boca", "Rubéola", "Sarampión", "Varicela", "Parotiditis", "Bronquiolitis", "Epiglotitis", "Laringotraqueitis CRUP", "Mononucleosis infecciosa", "Tos ferina", "IVU en menores"], "VACUNAS": ["Vacunas generalidades", "Tipos de vacunas", "Vacunación universal", "Aplicación de vacunas", "Vacuna para personal de salud", "Vacunas en el embarazo", "Esquema de vacunación", "BCG", "Hepatitis A", "Hepatitis B", "Hexavalente", "Influenza", "Neumocócica", "Rotavirus", "Sabin", "Salmonella", "DPT", "SRP", "Tétanos", "Varicela", "VPH"] };
                let flatTopicList = [];
                for (const specialty in newTopicsBySpecialty) { newTopicsBySpecialty[specialty].forEach(topic => flatTopicList.push({ specialty, topic })); }
                const newStudyBlock = [];
                let topicIndex = 0;
                let currentDate = new Date('2025-07-07T00:00:00');
                const endDate = new Date('2025-09-19T00:00:00');
                const daysInRange = Math.round((endDate - currentDate) / (1000 * 60 * 60 * 24)) + 1;
                const topicsPerDay = Math.floor(flatTopicList.length / daysInRange);
                let extraTopics = flatTopicList.length % daysInRange;
                while (currentDate <= endDate && topicIndex < flatTopicList.length) {
                    let chunkSize = topicsPerDay + (extraTopics > 0 ? 1 : 0);
                    const chunk = flatTopicList.slice(topicIndex, topicIndex + chunkSize);
                    if (chunk.length > 0) {
                        const dayData = { date: currentDate.toISOString().split('T')[0], blocks: [] };
                        let lastSpecialty = null;
                        chunk.forEach(item => { if (item.specialty !== lastSpecialty) { dayData.blocks.push({ subject: item.specialty, topics: [item.topic] }); lastSpecialty = item.specialty; } else { dayData.blocks[dayData.blocks.length - 1].topics.push(item.topic); } });
                        newStudyBlock.push(dayData);
                    }
                    topicIndex += chunkSize;
                    if(extraTopics > 0) { extraTopics--; }
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                let finalPlannedDays = [...plannedDaysPart1.reverse(), ...oftalmoDays, ...orlDays, ...newStudyBlock];
                let lastPlannedDate = new Date(finalPlannedDays[finalPlannedDays.length - 1].date);
                let finalCalendarDate = new Date('2025-09-30');
                while(lastPlannedDate < finalCalendarDate) { lastPlannedDate.setDate(lastPlannedDate.getDate() + 1); finalPlannedDays.push({ date: lastPlannedDate.toISOString().split('T')[0], blocks: [] }); }
                return finalPlannedDays.sort((a,b) => new Date(a.date) - new Date(b.date));
            }
            function getData(key, defaultValue = null) { const keys = key.split('.'); let result = userProgress; for (const k of keys) { if (result && typeof result === 'object' && k in result) { result = result[k]; } else { return defaultValue; } } return result; }
            function getSubjectForTopic(topicName) { const topicId = generateTopicId(topicName); for (const [subject, topicIds] of subjectToTopicsMap.entries()) { if (topicIds.includes(topicId)) { return subject; } } return null; }
            function populateCalendar(){if(!studyPlan)return;buildSubjectMap();const e=new Map(studyPlan.map(e=>[e.date,e]));const t=new Date(studyPlan[0].date+"T00:00:00"),a=new Date(studyPlan[studyPlan.length-1].date+"T00:00:00");let o="2025-09-22";let l=[];let n=new Date(t);n.setDate(n.getDate()-n.getDay());for(;n<=a;){let e=[];for(let t=0;t<7;t++)e.push(new Date(n)),n.setDate(n.getDate()+1);l.push(e)}const s=new Map;l.forEach((e,t)=>{const a=e[0].toLocaleString("es-ES",{month:"long"});s.has(a)?s.get(a).rowSpan++:s.set(a,{startRow:t+2,rowSpan:1})}),calendarContainer.innerHTML="",calendarContainer.innerHTML+='<div class="header-cell meta-header">M</div><div class="header-cell meta-header">S</div>',["Dom","Lun","Mar","Mié","Jue","Vie","Sáb"].forEach(e=>{calendarContainer.innerHTML+=`<div class="header-cell day-header">${e}</div>`}),s.forEach((e,t)=>{calendarContainer.innerHTML+=`<div class="month-cell" style="grid-row: ${e.startRow} / span ${e.rowSpan}">${t}</div>`}),l.forEach((a,l)=>{calendarContainer.innerHTML+=`<div class="week-cell-container" style="grid-row: ${l+2}"><span class="week-number">${l+1}</span></div>`;let n=new Set;a.forEach(a=>{const l=document.createElement("div");l.className="day-cell";const s=a.toISOString().split("T")[0];if(a<t||a>finalDate)l.classList.add("empty");else{l.dataset.date=s,l.innerHTML=`<div class="calendar-day-number">${a.getDate()}</div>`;const t=e.get(s);t&&t.blocks&&t.blocks.length>0&&t.blocks.some(e=>e.topics&&e.topics.length>0)&&(contentHTML="<ul>",new Set(t.blocks.map(e=>e.subject)).forEach(e=>{if(e&&!n.has(e)){const t=isSubjectComplete(e),a=t?" subject-completed":"",o=calculateSubjectScore(e),l=null!==o?`<span class="subject-score">(${o}%)</span>`:"";contentHTML+=`<li><span class="subject-title${a}">${e}${l}</span></li>`,n.add(e)}}),t.blocks.forEach(e=>{e.topics&&(contentHTML+=e.topics.map(createTopicListItem).join(""))}),contentHTML+="</ul>",l.innerHTML+=`<div class="day-content">${contentHTML}</div>`),s===countdownTargetDateStr&&l.classList.add("target-date"),s===o&&l.classList.add("day-before-target")}calendarContainer.appendChild(l)})}),updateGlobalProgressBars()}
            function createSpecialtyHeaderHTML(e,t){const a=generateTopicId(e);return`<div class="specialty-header" data-specialty-header="${e}" style="border-left-color: ${t}"><div class="specialty-header-main"><h3 style="color: ${t}">${e}</h3></div><div class="specialty-progress-wrapper"><small>Avance</small><div class="specialty-progress-container"><div class="specialty-progress-bar" id="sp-progress-${a}"></div></div><span class="specialty-percentage-text" id="sp-progress-text-${a}">0%</span></div><div class="specialty-progress-wrapper"><small>Nota</small><div class="specialty-progress-container"><div class="specialty-score-bar" id="sp-score-${a}"></div></div><span class="specialty-percentage-text" id="sp-score-text-${a}">0%</span></div></div>`}
            function populateKanbanBoard(){todoContainer.innerHTML="",inprogressContainer.innerHTML="",doneContainer.innerHTML="";const e=["var(--step-1-color)","var(--step-2-color)","var(--step-3-color)","var(--step-4-color)","var(--step-5-color)","var(--step-6-color)","#E6B0AA","#D7BDE2","#A9CCE3","#A3E4D7","#FAD7A0","#F5CBA7","#C8E6C9","#BBDEFB","#FFECB3","#D1C4E9"];let t=0;const a={};buildSubjectMap(),subjectToTopicsMap.forEach((l,n)=>{const s=l.map(e=>{for(const t of studyPlan)for(const a of t.blocks)if(a.topics){const t=a.topics.find(t=>generateTopicId(t)===e);if(t)return t}return null}).filter(Boolean);s.length>0&&(a[n]={topics:s,color:e[t%e.length]},t++)});for(const e in a){const t=a[e],l=createSpecialtyHeaderHTML(e,t.color),n={todo:document.createDocumentFragment(),inprogress:document.createDocumentFragment(),done:document.createDocumentFragment()};t.topics.forEach(e=>{const t=generateTopicId(e),a=getTopicKanbanState(t),s=createKanbanCardHTML(e,t);const r=document.createElement("div");r.innerHTML=s,n[a].appendChild(r.firstChild)}),n.todo.hasChildNodes()&&(todoContainer.innerHTML+=l,todoContainer.appendChild(n.todo)),n.inprogress.hasChildNodes()&&(inprogressContainer.innerHTML+=l,inprogressContainer.appendChild(n.inprogress)),n.done.hasChildNodes()&&(doneContainer.innerHTML+=l,doneContainer.appendChild(n.done))}updateAllSpecialtyProgressOnBoard()}
            function createKanbanCardHTML(e,t){const{completionPercentage:a,scorePercentage:l}=getTopicProgress(t),n=getScoreColor(l),s=getTopicKanbanState(t);let r="--color-todo";return"inprogress"===s&&(r="--color-inprogress"),"done"===s&&(r="--color-done"),`<article class="kanban-card" data-topic-id="${t}" data-topic-name="${e}" style="border-left: 4px solid var(${r});"><div class="card-summary"><div class="card-topic-name">${e}</div><div class="card-progress-display"><div class="card-progress-bar-container"><div class="card-progress-bar" style="width: ${a}%; background-color: var(${r});"></div></div><span class="card-progress-text">${a.toFixed(0)}%</span><span class="card-score-text" style="color: ${n}">${l.toFixed(0)}%</span></div></div></article>`}
            function showDayModal(e){const t=studyPlan.find(t=>t.date===e);if(!t)return;const a=new Date(e+"T00:00:00");dayModalTitle.textContent=a.toLocaleDateString("es-ES",{weekday:"long",day:"numeric",month:"long"});let l="<ul>";if(t&&t.blocks){let e=new Set;t.blocks.forEach(t=>{if(t.subject&&!e.has(t.subject)){const a=calculateSubjectScore(t.subject),n=null!==a?`<span class="subject-score">(${a}%)</span>`:"";l+=`<li><span class="subject-title">${t.subject}${n}</span></li>`,e.add(t.subject)}t.topics&&(l+=t.topics.map(e=>createTopicListItem(e)).join(""))})}l+="</ul>",dayModalNotes.value=getData(`dayNotes.${e}`,""),dayModal.dataset.currentDate=e,dayModalOverlay.classList.add("visible"),dayModal.classList.add("visible")}
            function closeDayModal(){dayModalOverlay.classList.remove("visible"),dayModal.classList.remove("visible")}
            function saveDayNote(){const e=dayModal.dataset.currentDate;e&&saveData(`dayNotes.${e}`,dayModalNotes.value),closeDayModal()}
            function showTopicPlan(e,t){topicModal.dataset.currentTopicId=e,topicModalTitle.textContent=t,loadTopicState(e),topicModalOverlay.classList.add("visible"),topicModal.classList.add("visible")}
            function closeTopicModal(){const e=topicModal.dataset.currentTopicId;topicModalOverlay.classList.remove("visible"),topicModal.classList.remove("visible"),e&&updateUIForTopic(e)}
            function loadTopicState(e){topicTaskCheckboxes.forEach(t=>{t.checked=getData(`topicData.${e}.${t.id}`)===!0}),aciertosInput.value=getData(`topicData.${e}.scoreAciertos`,""),reactivosInput.value=getData(`topicData.${e}.scoreReactivos`,""),updateScorePercentage(),updateAllStepCardsStatus()}
            function saveTopicState(e,t){const a=topicModal.dataset.currentTopicId;a&&saveData(`topicData.${a}.${e}`,t)}
            function updateScorePercentage(){const e=parseInt(aciertosInput.value)||0,t=parseInt(reactivosInput.value)||0;let a=0;t>0&&(a=e/t*100);const l=getScoreColor(a);percentageOutput.value=a.toFixed(2)+"%",percentageOutput.style.color=l}
            function updateStepCardStatus(e){const t=e.querySelectorAll(".task-checkbox"),a=Array.from(t).every(e=>e.checked);e.classList.toggle("completed",a)}
            function updateAllStepCardsStatus(){topicStepCards.forEach(updateStepCardStatus)}
            function finishTopicSession(){closeTopicModal()}
            function updateUIForTopic(e){boardView.classList.contains("hidden")?populateCalendar():populateKanbanBoard(),updateGlobalProgressBars()}
            function updateAllSpecialtyProgressOnBoard(){const e=document.querySelectorAll(".specialty-header");e.forEach(e=>{const t=e.dataset.specialtyHeader,a=generateTopicId(t),l=subjectToTopicsMap.get(t)||[],n=document.getElementById(`sp-progress-text-${a}`),s=document.getElementById(`sp-score-text-${a}`),r=document.getElementById(`sp-progress-${a}`),c=document.getElementById(`sp-score-${a}`);if(n&&s&&r&&c){let e=0,t=0,o=0;l.forEach(a=>{const{completionPercentage:l,scorePercentage:n}=getTopicProgress(a);e+=l;const s=parseInt(getData(`topicData.${a}.scoreReactivos`))||0;(s>0||isTopicComplete(a))&&(t+=n,o++)});const i=l.length>0?e/l.length:0,d=o>0?t/o:0;r.style.width=`${i}%`,n.textContent=`${i.toFixed(0)}%`,c.style.width=`${d}%`,s.textContent=`${d.toFixed(0)}%`,c.classList.remove("low","medium","high");if(o>0||100===i){const e=getScoreColor(d);e.includes("error")&&c.classList.add("low"),e.includes("warning")&&c.classList.add("medium"),e.includes("green")&&c.classList.add("high")}}})}
            function main() {
                assignDOMelements();
                displayDailyQuote();
                const authBtn = document.getElementById('auth-btn');
                const userDisplay = document.getElementById('user-display');
                auth.onAuthStateChanged(user => {
                    if (user) {
                        currentUser = user;
                        userDisplay.textContent = user.displayName || user.email;
                        userDisplay.style.display = 'inline';
                        authBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Logout';
                        authBtn.style.backgroundColor = 'var(--error-color)';
                        loadProgressFromFirestore();
                    } else {
                        currentUser = null;
                        userDisplay.style.display = 'none';
                        authBtn.innerHTML = '<i class="fas fa-user-circle"></i> Login / Registrarse';
                        authBtn.style.backgroundColor = '#4A90E2';
                        calendarContainer.innerHTML = '<h2 style="text-align:center; padding: 40px;">Inicia sesión para ver y guardar tu progreso.</h2>';
                    }
                });
                authBtn.addEventListener('click', () => { if (currentUser) { auth.signOut(); } else { openAuthModal(); } });
                authModalCloseBtn.addEventListener('click', closeAuthModal);
                authModalOverlay.addEventListener('click', closeAuthModal);
                loginForm.addEventListener('submit', handleLogin);
                registerForm.addEventListener('submit', handleRegistration);
                showRegisterBtn.addEventListener('click', () => { loginForm.style.display = 'none'; document.getElementById('form-switcher-login').style.display = 'none'; registerForm.style.display = 'block'; document.getElementById('form-switcher-register').style.display = 'block'; authModalTitle.textContent = 'Registrarse'; authErrorMessage.textContent = ''; });
                showLoginBtn.addEventListener('click', () => { registerForm.style.display = 'none'; document.getElementById('form-switcher-register').style.display = 'none'; loginForm.style.display = 'block'; document.getElementById('form-switcher-login').style.display = 'block'; authModalTitle.textContent = 'Iniciar Sesión'; authErrorMessage.textContent = ''; });
                viewSwitcher.addEventListener('click', switchView);
                dayModal.querySelector('#modal-close-day').addEventListener('click', closeDayModal);
                dayModalOverlay.addEventListener('click', closeDayModal);
                topicModal.querySelector('#modal-close-topic').addEventListener('click', closeTopicModal);
                finishTopicButton.addEventListener('click', finishTopicSession);
                document.addEventListener('keydown', e => { if (e.key === 'Escape') { if (authModal.classList.contains('visible')) closeAuthModal(); else if (topicModal.classList.contains('visible')) closeTopicModal(); else if (dayModal.classList.contains('visible')) closeDayModal(); } });
                saveNoteButton.addEventListener('click', saveDayNote);
                topicTaskCheckboxes.forEach(checkbox => { checkbox.addEventListener('change', function() { const topicId = topicModal.dataset.currentTopicId; saveTopicState(this.id, this.checked); updateStepCardStatus(this.closest('.step-card')); updateUIForTopic(topicId); }); });
                aciertosInput.addEventListener('input', () => { const topicId = topicModal.dataset.currentTopicId; saveTopicState('scoreAciertos', aciertosInput.value); updateScorePercentage(); updateUIForTopic(topicId); });
                reactivosInput.addEventListener('input', () => { const topicId = topicModal.dataset.currentTopicId; saveTopicState('scoreReactivos', reactivosInput.value); updateScorePercentage(); updateUIForTopic(topicId); });
                calendarContainer.addEventListener('click', e => { const topicLi = e.target.closest('.topic-item'); if (topicLi && !draggedItem) { const { topicId, topicName } = topicLi.dataset; showTopicPlan(topicId, topicName); return; } const cell = e.target.closest('.day-cell:not(.empty)'); if (cell) showDayModal(cell.dataset.date); });
                dayModalTopicsContainer.addEventListener('click', e => { const topicLi = e.target.closest('.topic-item'); if (topicLi) { const { topicId, topicName } = topicLi.dataset; showTopicPlan(topicId, topicName); } });
                editCountdownBtn.addEventListener('click', () => { countdownEditor.style.display = countdownEditor.style.display === 'flex' ? 'none' : 'flex'; });
                saveCountdownBtn.addEventListener('click', () => { const newDate = countdownDatePicker.value; if (newDate) { countdownTargetDateStr = newDate; saveData('countdownTarget', newDate); startCountdown(); populateCalendar(); countdownEditor.style.display = 'none'; } });
                calendarContainer.addEventListener('dragstart', e => { if (e.target.classList.contains('topic-item')) { draggedItem = e.target; const topicName = draggedItem.dataset.topicName; const subjectTitle = getSubjectForTopic(topicName); e.dataTransfer.setData('application/json', JSON.stringify({ topicName: topicName, sourceSubject: subjectTitle })); setTimeout(() => e.target.classList.add('dragging'), 0); } });
                calendarContainer.addEventListener('dragend', e => { if (draggedItem) { draggedItem.classList.remove('dragging'); draggedItem = null; clearDragStyles(); } });
                let draggedItem = null, lastDragOverCell = null, lastDragOverTopic = null; function clearDragStyles() { if (lastDragOverCell) lastDragOverCell.classList.remove('drag-over'); if (lastDragOverTopic) lastDragOverTopic.classList.remove('drag-over-top', 'drag-over-bottom'); lastDragOverCell = null; lastDragOverTopic = null; }
                calendarContainer.addEventListener('dragover', e => { e.preventDefault(); const targetCell = e.target.closest('.day-cell:not(.empty)'); if (!targetCell || !draggedItem) { clearDragStyles(); return; } const sourceDate = draggedItem.closest('.day-cell').dataset.date; const targetDate = targetCell.dataset.date; clearDragStyles(); if (sourceDate === targetDate) { const targetTopic = e.target.closest('.topic-item'); if (targetTopic && targetTopic !== draggedItem) { lastDragOverTopic = targetTopic; const rect = targetTopic.getBoundingClientRect(); const midpointY = rect.top + rect.height / 2; if (e.clientY < midpointY) { targetTopic.classList.add('drag-over-top'); } else { targetTopic.classList.add('drag-over-bottom'); } } } else { lastDragOverCell = targetCell; targetCell.classList.add('drag-over'); } });
                calendarContainer.addEventListener('drop', e => { e.preventDefault(); if (!draggedItem) return; const targetCell = e.target.closest('.day-cell'); if (!targetCell || targetCell.classList.contains('empty')) { clearDragStyles(); return; } const sourceCell = draggedItem.closest('.day-cell'); const sourceDate = sourceCell.dataset.date; const targetDate = targetCell.dataset.date; const { topicName, sourceSubject } = JSON.parse(e.dataTransfer.getData('application/json')); const sourceDay = studyPlan.find(d => d.date === sourceDate); if (!sourceDay) return; let removed = false; sourceDay.blocks.forEach(block => { if (block.topics) { const topicIndex = block.topics.indexOf(topicName); if (topicIndex > -1) { block.topics.splice(topicIndex, 1); removed = true; } } }); if (!removed) return; let targetDay = studyPlan.find(d => d.date === targetDate); if (!targetDay) { targetDay = { date: targetDate, blocks: [{ topics: [] }] }; studyPlan.push(targetDay); } let targetBlock = targetDay.blocks.find(b => getSubjectForTopic(b.topics?.[0]) === sourceSubject || b.subject === sourceSubject); if (!targetBlock) { targetBlock = { subject: sourceSubject, topics: [] }; targetDay.blocks.unshift(targetBlock); } const targetTopicEl = e.target.closest('.topic-item'); if (targetTopicEl && sourceDate === targetDate) { const targetTopicName = targetTopicEl.dataset.topicName; const rect = targetTopicEl.getBoundingClientRect(); const midpointY = rect.top + rect.height / 2; const insertBefore = e.clientY < midpointY; const targetIndex = targetBlock.topics.indexOf(targetTopicName); targetBlock.topics.splice(insertBefore ? targetIndex : targetIndex + 1, 0, topicName); } else { if (!targetBlock.topics) targetBlock.topics = []; targetBlock.topics.push(topicName); } studyPlan.forEach(day => { day.blocks = day.blocks.filter(block => (block.subject && block.topics && block.topics.length > 0) || (block.subject && (!block.topics || block.topics.length === 0))); }); studyPlan.sort((a, b) => new Date(a.date) - new Date(b.date)); clearDragStyles(); saveData('studyPlan', studyPlan); populateCalendar(); });
            }
            
            main();
        };
        initializeAppLogic();
    });
    </script>
</body>
</html>
